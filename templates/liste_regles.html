{% extends "base.html" %}

{% block title %}R√®gles d'affectation - SaaS FEC{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1>üìã R√®gles d'affectation</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/dashboard">Tableau de bord</a></li>
                {% if fec_file %}
                <li class="breadcrumb-item"><a href="/fec/{{ fec_file.id }}">{{ fec_file.nom_original }}</a></li>
                {% endif %}
                <li class="breadcrumb-item active">R√®gles</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mt-3">
    <div class="col-12">
        {% if regles %}
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">‚öôÔ∏è R√®gles configur√©es ({{ regles|length }})</h5>
                {% if fec_file %}
                <a href="/regles/nouvelle?fec_id={{ fec_file.id }}" class="btn btn-success">
                    ‚ú® Cr√©er une nouvelle r√®gle
                </a>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Nom de la r√®gle</th>
                                <th>Mots-cl√©s</th>
                                <th>Journal</th>
                                <th>Compte destination</th>
                                <th>Couverture</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for regle in regles %}
                            <tr id="regle-{{ regle.id }}">
                                <td>
                                    <strong>{{ regle.nom }}</strong><br>
                                    <small class="text-muted">Cr√©√© le {{ regle.created_at.strftime('%d/%m/%Y') }}</small>
                                </td>
                                <td>
                                    {% for mot_cle in regle.mots_cles %}
                                        <span class="badge bg-primary me-1">{{ mot_cle }}</span>
                                    {% endfor %}
                                    {% if regle.criteres_montant %}
                                    <br><small class="text-muted">
                                        Montant {{ regle.criteres_montant.operateur }} {{ regle.criteres_montant.valeur }} ‚Ç¨
                                    </small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if regle.journal_code %}
                                        <span class="badge bg-info">{{ regle.journal_code }}</span>
                                    {% else %}
                                        <span class="text-muted">Tous</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <code>{{ regle.compte_destination }}</code><br>
                                    <small class="text-muted">{{ regle.libelle_destination }}</small>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress me-2" style="width: 100px; height: 8px;">
                                            <div class="progress-bar bg-success"
                                                 style="width: {{ regle.pourcentage_couverture_total }}%"></div>
                                        </div>
                                        <small>
                                            <strong>{{ regle.pourcentage_couverture_total }}%</strong><br>
                                            <span class="text-muted">{{ regle.nb_transactions_couvertes }} trans.</span>
                                        </small>
                                    </div>
                                </td>
                                <td>
                                    {% if regle.is_active %}
                                        <span class="badge bg-success">Active</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Inactive</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="testerRegle({{ regle.id }})">
                                            üî¨ Tester
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="supprimerRegle({{ regle.id }}, '{{ regle.nom }}')">
                                            üóëÔ∏è Supprimer
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="card-body text-center py-5">
                <h5 class="text-muted">Aucune r√®gle d'affectation configur√©e</h5>
                <p class="text-muted">
                    Cr√©ez votre premi√®re r√®gle pour automatiser l'affectation de vos transactions bancaires.
                </p>
                {% if fec_file %}
                <a href="/regles/nouvelle?fec_id={{ fec_file.id }}" class="btn btn-success mt-3">
                    ‚ú® Cr√©er ma premi√®re r√®gle
                </a>
                {% else %}
                <a href="/import-fec" class="btn btn-primary mt-3">
                    üìÅ Importer un fichier FEC d'abord
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal de test de r√®gle -->
<div class="modal fade" id="testRegleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üî¨ Test de la r√®gle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="testRegleContent">
                <!-- Contenu du test sera inject√© ici -->
            </div>
        </div>
    </div>
</div>

<script>
function testerRegle(regleId) {
    // TODO: Impl√©menter le test de r√®gle
    alert('Fonctionnalit√© de test - √Ä impl√©menter !');
}

function supprimerRegle(regleId, nomRegle) {
    if (confirm(`√ätes-vous s√ªr de vouloir supprimer la r√®gle "${nomRegle}" ?`)) {
        fetch(`/regles/${regleId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Supprimer la ligne du tableau
                document.getElementById(`regle-${regleId}`).remove();

                // Si plus de r√®gles, afficher le message vide
                const tbody = document.querySelector('tbody');
                if (tbody.children.length === 0) {
                    location.reload();
                }
            } else {
                alert('‚ùå Erreur lors de la suppression : ' + result.error);
            }
        })
        .catch(error => {
            alert('‚ùå Erreur de communication : ' + error);
        });
    }
}
</script>
{% endblock %}