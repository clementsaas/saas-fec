<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ societe.nom }} - Affectia</title>
    <link rel="icon" href="/static/images/favicon.png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Style Apple */
/* Override des styles sidebar pour un espacement cohérent */
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f5f5f7;
    margin: 0;
    padding: 0;
    color: #1d1d1f;
    overflow: hidden;
    height: 100vh;
    margin-left: 225px !important;
    transition: margin-left 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
}

body.sidebar-collapsed {
    margin-left: 53px !important;
}

.main-container {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 20px;
    padding: 20px 20px 5px 20px;
    height: calc(100vh - 0px);
    margin-left: -280px;
    padding-left: 300px;
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    box-sizing: border-box;
}

.main-container.sidebar-collapsed {
    margin-left: 0 !important;
    padding-left: 20px !important;
}

.ai-search-wrapper {
    position: relative;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(0, 0, 0, 0.08);
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
}

.ai-search-wrapper:hover {
    background: rgba(255, 255, 255, 0.9);
    border-color: rgba(0, 122, 255, 0.3);
    box-shadow: 0 2px 8px rgba(0, 122, 255, 0.1);
}

.ai-search-wrapper:focus-within {
    background: rgba(255, 255, 255, 0.95);
    border-color: rgba(156, 163, 175, 0.6);
    box-shadow: 0 0 0 3px rgba(156, 163, 175, 0.15);
}

.ai-search-input {
    width: 100%;
    padding: 10px 16px 10px 40px;
    border: none;
    background: transparent;
    font-size: 14px;
    font-weight: 400;
    color: #1d1d1f;
    outline: none;
    transition: all 0.2s ease;
}

.ai-search-input::placeholder {
    color: #86868b;
    font-weight: 400;
}

.ai-search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #86868b;
    transition: color 0.2s ease;
}

.ai-search-wrapper:focus-within .ai-search-icon {
    color: #007aff;
}

/* Liste des sociétés Apple Intelligence */
.ai-companies-list {
    max-height: 200px;
    overflow-y: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.ai-companies-list::-webkit-scrollbar {
    display: none;
}

.ai-company-item:hover::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(
        45deg,
        transparent 30%,
        rgba(255, 255, 255, 0.3) 50%,
        transparent 70%
    );
    animation: aiCompanyShine 2s ease-in-out infinite;
    pointer-events: none;
}

@keyframes aiCompanyShine {
    0%, 100% {
        transform: translateX(-100%) rotate(45deg);
        opacity: 0;
    }
    50% {
        transform: translateX(100%) rotate(45deg);
        opacity: 0.6;
    }
}

.ai-company-item.selected {
    background: linear-gradient(135deg,
        rgba(0, 122, 255, 0.12) 0%,
        rgba(88, 86, 214, 0.08) 100%);
    transform: translateY(-1px);
    box-shadow:
        0 4px 16px rgba(0, 122, 255, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
}

.ai-company-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    z-index: 2;
}

.ai-company-main {
    flex: 1;
    min-width: 0;
}

.ai-company-name {
    font-size: 14px;
    font-weight: 600;
    color: #1d1d1f;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.ai-company-siret {
    font-size: 12px;
    color: #86868b;
    font-weight: 400;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.ai-current-indicator {
    color: #007aff;
    margin-left: 12px;
    opacity: 0.8;
    transition: opacity 0.2s ease;
}

.ai-company-item:hover .ai-current-indicator {
    opacity: 1;
}

/* État sélectionné avec navigation clavier */
.ai-company-item.keyboard-selected {
    background: linear-gradient(135deg,
        rgba(0, 122, 255, 0.15) 0%,
        rgba(88, 86, 214, 0.10) 100%);
    transform: translateY(-1px);
    box-shadow:
        0 4px 16px rgba(0, 122, 255, 0.18),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
}

/* Indicateur de dropdown */
.dropdown-indicator {
    margin-left: 8px;
    color: #86868b;
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    opacity: 0.7;
}

.company-section:hover .dropdown-indicator {
    opacity: 1;
    transform: translateY(1px);
}

/* Apple Intelligence Dropdown */
.apple-intelligence-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    width: 450px;
    background: linear-gradient(135deg,
        rgba(255, 255, 255, 0.95) 0%,
        rgba(247, 250, 252, 0.92) 30%,
        rgba(255, 255, 255, 0.90) 100%);
    backdrop-filter: blur(30px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.4);
    border-radius: 20px;
    box-shadow:
        0 20px 60px rgba(0, 0, 0, 0.15),
        0 8px 32px rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
    display: none;
    z-index: 10000;
    overflow: hidden;
    animation: aiDropdownAppear 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

@keyframes aiDropdownAppear {
    0% {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.ai-dropdown-content {
    padding: 8px;
}

/* Barre de recherche Apple Intelligence */
.ai-search-container {
    padding: 8px 0 12px 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    margin-bottom: 8px;
}

.ai-search-wrapper {
    position: relative;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(0, 0, 0, 0.08);
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
}

.ai-search-wrapper:hover {
    background: rgba(255, 255, 255, 0.9);
    border-color: rgba(0, 122, 255, 0.3);
    box-shadow: 0 2px 8px rgba(0, 122, 255, 0.1);
}

.ai-search-wrapper:focus-within {
    background: rgba(255, 255, 255, 0.95);
    border-color: rgba(156, 163, 175, 0.6);
    box-shadow: 0 0 0 3px rgba(156, 163, 175, 0.15);
}

.ai-search-input {
    width: 100%;
    padding: 10px 16px 10px 40px;
    border: none;
    background: transparent;
    font-size: 14px;
    font-weight: 400;
    color: #1d1d1f;
    outline: none;
    transition: all 0.2s ease;
}

.ai-search-input::placeholder {
    color: #86868b;
    font-weight: 400;
}

.ai-search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #86868b;
    transition: color 0.2s ease;
}

.ai-search-wrapper:focus-within .ai-search-icon {
    color: #007aff;
}

/* Liste des sociétés Apple Intelligence */
.ai-companies-list {
    max-height: 200px;
    overflow-y: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.ai-companies-list::-webkit-scrollbar {
    display: none;
}

.ai-company-item {
    padding: 12px 16px;
    border-radius: 12px;
    margin-bottom: 4px;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    background: transparent;
    position: relative;
    overflow: hidden;
}

.ai-company-item:hover {
    background: linear-gradient(135deg,
        rgba(0, 122, 255, 0.08) 0%,
        rgba(88, 86, 214, 0.06) 100%);
    transform: translateY(-1px) scale(1.01);
    box-shadow:
        0 4px 16px rgba(0, 122, 255, 0.12),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
}

.ai-company-item:hover::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(
        45deg,
        transparent 30%,
        rgba(255, 255, 255, 0.3) 50%,
        transparent 70%
    );
    animation: aiCompanyShine 2s ease-in-out infinite;
    pointer-events: none;
}

@keyframes aiCompanyShine {
    0%, 100% {
        transform: translateX(-100%) rotate(45deg);
        opacity: 0;
    }
    50% {
        transform: translateX(100%) rotate(45deg);
        opacity: 0.6;
    }
}

.ai-company-item.selected {
    background: linear-gradient(135deg,
        rgba(0, 122, 255, 0.12) 0%,
        rgba(88, 86, 214, 0.08) 100%);
    transform: translateY(-1px);
    box-shadow:
        0 4px 16px rgba(0, 122, 255, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
}

.ai-company-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    z-index: 2;
}

.ai-company-main {
    flex: 1;
    min-width: 0;
}

.ai-company-name {
    font-size: 14px;
    font-weight: 600;
    color: #1d1d1f;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.ai-company-siret {
    font-size: 12px;
    color: #86868b;
    font-weight: 400;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.ai-current-indicator {
    color: #007aff;
    margin-left: 12px;
    opacity: 0.8;
    transition: opacity 0.2s ease;
}

.ai-company-item:hover .ai-current-indicator {
    opacity: 1;
}

/* État sélectionné avec navigation clavier */
.ai-company-item.keyboard-selected {
    background: linear-gradient(135deg,
        rgba(0, 122, 255, 0.15) 0%,
        rgba(88, 86, 214, 0.10) 100%);
    transform: translateY(-1px);
    box-shadow:
        0 4px 16px rgba(0, 122, 255, 0.18),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
}

@keyframes companySpecularMove {
    0%, 100% {
        transform: translate(-30%, -30%) rotate(45deg);
        opacity: 0.4;
    }
    50% {
        transform: translate(30%, 30%) rotate(45deg);
        opacity: 0.8;
    }
}

.company-layout {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    position: relative;
    z-index: 2;
}

.company-name-section h2 {
    margin: 0;
    color: #1d1d1f;
    font-size: 20px;
    font-weight: 600;
    line-height: 1.2;
    letter-spacing: -0.02em;
}

.automation-score-section {
    display: flex;
    align-items: center;
}

.automation-glass-background {
    position: relative;
    background: linear-gradient(135deg,
        rgba(102, 126, 234, 0.1) 0%,
        rgba(118, 75, 162, 0.08) 50%,
        rgba(102, 126, 234, 0.12) 100%);
    backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(102, 126, 234, 0.2);
    border-radius: 12px;
    padding: 6px 16px;
    overflow: hidden;
    box-shadow:
        0 2px 8px rgba(102, 126, 234, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.4);
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
}

.automation-glass-background:hover {
    transform: translateY(-1px);
    box-shadow:
        0 4px 12px rgba(102, 126, 234, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.automation-specular-highlight {
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent 45%,
        rgba(255, 255, 255, 0.08) 50%,
        transparent 55%
    );
    animation: automationSpecularMove 6s ease-in-out infinite;
    pointer-events: none;
    opacity: 0.7;
}

@keyframes automationSpecularMove {
    0%, 100% {
        transform: translate(-40%, -40%) rotate(45deg);
        opacity: 0.5;
    }
    50% {
        transform: translate(40%, 40%) rotate(45deg);
        opacity: 0.9;
    }
}

.automation-content {
    position: relative;
    z-index: 2;
    display: flex;
    align-items: center;
    font-size: 14px;
    font-weight: 600;
    color: #667eea;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.3);
}

.automation-content .percentage {
    font-weight: 700;
    color: #667eea;
}

/* Nouveau dropdown moderne */
.company-dropdown-modern {
    position: absolute;
    top: 100%;
    left: 0;
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    width: 400px;
    max-height: 350px;
    overflow: hidden;
    z-index: 1001;
    display: none;
    margin-top: 8px;
    border: 1px solid rgba(0,0,0,0.06);
}

.company-search-modern {
    padding: 15px;
    border-bottom: 1px solid #f5f5f7;
    background: #f9f9fb;
}

.company-search-input-modern {
    width: 100%;
    padding: 8px 12px 8px 35px;
    border: 1px solid #d2d2d7;
    border-radius: 12px;
    font-size: 13px;
    background: white;
    transition: border-color 0.2s ease;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23999' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: 10px center;
}

.company-search-input-modern:focus {
    outline: none;
    border-color: #007aff;
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
}

.company-list-modern {
    max-height: 250px;
    overflow-y: auto;
}

.company-item-modern {
    padding: 12px 20px;
    cursor: pointer;
    transition: all 0.25s ease;
    border-bottom: 1px solid #f5f5f7;
    position: relative;
    overflow: hidden;
}

.company-item-modern:hover {
    background: linear-gradient(135deg, #f3f4f7 0%, #eaecf0 100%);
    transform: translateX(2px);
    box-shadow:
        0 2px 8px rgba(243, 244, 247, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    border-radius: 0 8px 8px 0;
    border-left: 3px solid #c5c9d0;
}

.company-item-modern:hover::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(
        45deg,
        transparent 40%,
        rgba(255, 255, 255, 0.4) 50%,
        transparent 60%
    );
    animation: companyItemShine 4s ease-in-out infinite;
    pointer-events: none;
}

@keyframes companyItemShine {
    0%, 100% {
        transform: translateX(-100%) rotate(45deg);
        opacity: 0;
    }
    50% {
        transform: translateX(100%) rotate(45deg);
        opacity: 0.3;
    }
}

.company-item-modern:last-child {
    border-bottom: none;
}

.company-item-content {
    position: relative;
    z-index: 2;
}

.company-item-name {
    font-weight: 500;
    color: #1d1d1f;
    font-size: 14px;
    margin-bottom: 2px;
}

.company-item-modern:hover .company-item-name {
    color: #2c3e50;
    font-weight: 600;
}

.company-item-info {
    font-size: 12px;
    color: #86868b;
    font-weight: 400;
}

.company-item-modern:hover .company-item-info {
    color: #34495e;
}

.logo-lune {
    width: 65px;
    height: 65px;
    fill: #1d1d1f;
}

        .action-buttons {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn-apple {
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 14px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #e5e5ea;
            color: #1d1d1f;
        }

        .btn-apple:hover {
            background: #d1d1d6;
        }

        .btn-apple.primary {
            background: #1d1d1f;
            color: white;
        }

        .btn-apple.primary:hover {
            background: #000;
        }

        .settings-dropdown {
            position: relative;
        }

        .settings-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
            fill: #1d1d1f;
            transition: transform 0.2s ease;
        }

        .settings-icon:hover {
            transform: rotate(30deg);
        }

        .dropdown-menu-apple {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            min-width: 200px;
            margin-top: 8px;
            padding: 8px;
            display: none;
            z-index: 1001;
        }

        .dropdown-item-apple {
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 14px;
        }

        .dropdown-item-apple:hover {
            background: #f5f5f7;
        }

.main-container {
    display: grid;
    grid-template-columns: 400px 1fr 350px;
    gap: 20px;
    padding: 20px;
    height: calc(100vh - 5px);
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    box-sizing: border-box;
}

.panel {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: calc(100vh - 30px);
}

        .panel-header {
            background: white;
            color: #1d1d1f;
            padding: 20px;
            font-weight: 600;
            font-size: 16px;
            border-bottom: 1px solid #f5f5f7;
        }

.panel-body {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    min-height: 0;
}

/* Scrollbars discrètes pour les panneaux de contrepartie et transactions uniquement */
.panel-body::-webkit-scrollbar {
    width: 6px;
}

.panel-body::-webkit-scrollbar-track {
    background: transparent;
}

.panel-body::-webkit-scrollbar-thumb {
    background: rgba(134, 134, 139, 0.3);
    border-radius: 3px;
    transition: background 0.2s ease;
}

.panel-body::-webkit-scrollbar-thumb:hover {
    background: rgba(134, 134, 139, 0.5);
}

/* Firefox */
.panel-body {
    scrollbar-width: thin;
    scrollbar-color: rgba(134, 134, 139, 0.3) transparent;
}

        .search-container {
            padding: 15px 20px;
            background: #f9f9fb;
            border-bottom: 1px solid #e5e5ea;
        }

.search-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

.search-clear-btn {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    border-radius: 50%;
    color: #86868b;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
}

.search-clear-btn:hover {
    background: rgba(134, 134, 139, 0.1);
    color: #1d1d1f;
    transform: translateY(-50%) scale(1.1);
}

.search-clear-btn:active {
    transform: translateY(-50%) scale(0.95);
}

.search-input {
    padding-right: 35px !important; /* Laisser de la place pour l'icône */
}

        .search-input {
            width: 100%;
            padding: 8px 12px 8px 35px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            transition: border-color 0.2s ease;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23999' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 10px center;
        }

.search-input:focus {
    outline: none;
    border-color: #9ca3af;
    box-shadow: 0 0 0 3px rgba(156, 163, 175, 0.15);
}

.comptes-header {
            display: grid;
            grid-template-columns: 1fr 85px;
            gap: 8px;
            padding: 10px 20px 10px 15px;
            background: #f9f9fb;
            font-size: 11px;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e5e5ea;
            text-align: center;
        }

        .comptes-header .sortable-header {
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }

.comptes-header .sortable-header:first-child {
            justify-content: flex-start;
        }

        .comptes-header .sortable-header:last-child {
            justify-content: flex-end;
        }

        .sortable-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.2s ease;
        }

        .sortable-header:hover {
            color: #1d1d1f;
        }

        .sort-icon {
            font-size: 12px;
            color: #d2d2d7;
            opacity: 0;
            transition: opacity 0.2s ease;
            margin-left: 4px;
        }

        .sortable-header:hover .sort-icon {
            opacity: 1;
        }

        .sort-icon.active {
            opacity: 1;
            color: #1d1d1f;
        }

        .sort-icon.asc::before {
            content: '↑';
        }

        .sort-icon.desc::before {
            content: '↓';
        }

        .sort-icon:not(.asc):not(.desc)::before {
            content: '↓';
        }

        #sort-icon-compte:not(.asc):not(.desc)::before {
            content: '↑';
        }

.compte-item {
    display: grid;
    grid-template-columns: 1fr 85px;
    gap: 8px;
    padding: 10px 20px 10px 15px;
    border-bottom: 1px solid #f5f5f7;
    cursor: pointer;
    transition: all 0.25s ease;
    align-items: center;
    height: 60px;
    position: relative;
    border-radius: 0;
}

.compte-item:hover {
    background: #f8f9fb;
    transform: translateX(1px);
}

.compte-item.selected {
    background: linear-gradient(135deg, #f3f4f7 0%, #eaecf0 100%);
    color: #1d1d1f;
    border-left: 3px solid #c5c9d0;
    transform: translateX(2px);
    box-shadow:
        0 2px 8px rgba(243, 244, 247, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    border-radius: 0 8px 8px 0;
    position: relative;
    overflow: hidden;
}

.compte-item.selected .compte-number {
    color: #2c3e50;
    font-weight: 600;
}

.compte-item.selected .compte-libelle {
    color: #34495e;
}

.compte-item.selected .compte-percentage {
    color: #2c3e50;
    font-weight: 600;
}

.compte-item.selected .stat-afaire {
    color: #27AE60;
    font-weight: 600;
}

.compte-item.selected::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(
        45deg,
        transparent 40%,
        rgba(255, 255, 255, 0.4) 50%,
        transparent 60%
    );
    animation: selectedShine 4s ease-in-out infinite;
    pointer-events: none;
}

@keyframes selectedShine {
    0%, 100% {
        transform: translateX(-100%) rotate(45deg);
        opacity: 0;
    }
    50% {
        transform: translateX(100%) rotate(45deg);
        opacity: 0.3;
    }
}

        .compte-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0; /* Permet la troncature */
            overflow: hidden;
        }

        .compte-number {
            font-size: 11px;
            color: #86868b;
            font-weight: 400;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .compte-libelle {
            font-weight: 500;
            font-size: 11px;
            color: #1d1d1f;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-transform: uppercase;
        }

.compte-percentage {
            text-align: center;
            font-weight: 500;
            color: #1d1d1f;
            font-size: 12px;
            position: relative;
            cursor: help;
            display: flex;
            align-items: center;
            justify-content: center;
        }

.stat-afaire {
            text-align: center;
            font-weight: 500;
            color: #27AE60;
            font-size: 12px;
            position: relative;
            cursor: help;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tooltip-custom {
            position: absolute;
            background: #1d1d1f;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 99999;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 5px;
        }

        .tooltip-custom::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-bottom-color: #1d1d1f;
        }

.tooltip-banque {
    position: fixed;
    background: #1d1d1f;
    color: white;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 500;
    z-index: 99999;
    opacity: 0;
    transition: opacity 0.2s ease;
    pointer-events: none;
    white-space: nowrap;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.tooltip-banque::after {
    content: '';
    position: absolute;
    bottom: 100%;
    left: 20px;
    border: 4px solid transparent;
    border-bottom-color: #1d1d1f;
}

.transaction-banque {
    position: relative;
}

.transactions-header {
            display: grid;
            grid-template-columns: 80px 1fr 120px;
            gap: 15px;
            padding: 10px 20px 10px 15px;
            background: #f9f9fb;
            font-size: 11px;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e5e5ea;
        }

        .sortable-transaction-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.2s ease;
        }

        .sortable-transaction-header:hover {
            color: #1d1d1f;
        }

        .sort-icon-transaction {
            font-size: 12px;
            color: #d2d2d7;
            opacity: 0;
            transition: opacity 0.2s ease;
            margin-left: 4px;
        }

.sortable-transaction-header:hover .sort-icon-transaction {
            opacity: 1;
        }

.sortable-transaction-header:last-child {
            text-align: right;
            justify-content: flex-end;
            padding-right: 0px;
        }

        .sort-icon-transaction.active {
            opacity: 1;
            color: #1d1d1f;
        }

        .sort-icon-transaction.asc::before {
            content: '↑';
        }

        .sort-icon-transaction.desc::before {
            content: '↓';
        }

        .sort-icon-transaction:not(.asc):not(.desc)::before {
            content: '↑';
        }

.filter-section {
    padding: 12px 20px;
    background: #f9f9fb;
    border-bottom: 1px solid #e5e5ea;
}

.search-and-filter-container {
    display: flex;
    align-items: center;
    gap: 12px;
}

.search-wrapper-with-filter {
    position: relative;
    display: flex;
    align-items: center;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid #d2d2d7;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    flex: 1;
}

.search-wrapper-with-filter:hover {
    background: rgba(255, 255, 255, 0.9);
    border-color: rgba(0, 122, 255, 0.3);
    box-shadow: 0 2px 8px rgba(0, 122, 255, 0.1);
}

.search-wrapper-with-filter:focus-within {
    background: rgba(255, 255, 255, 0.95);
    border-color: rgba(0, 122, 255, 0.5);
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
}

.search-keywords-input-modern {
    flex: 1;
    padding: 10px 16px 10px 40px;
    border: none;
    background: transparent;
    font-size: 13px;
    font-weight: 400;
    color: #1d1d1f;
    outline: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23999' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: 12px center;
}

.search-keywords-input-modern::placeholder {
    color: #86868b;
    font-weight: 400;
}

.filter-toggle-btn {
    position: relative;
    padding: 10px 16px;
    border: none;
    background: transparent;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    color: #86868b;
    display: flex;
    align-items: center;
    justify-content: center;
    border-left: 1px solid rgba(0, 0, 0, 0.06);
}

.filter-toggle-btn:hover {
    background: rgba(0, 122, 255, 0.08);
    color: #007aff;
}

.filter-indicator {
    position: absolute;
    top: 6px;
    right: 6px;
    width: 8px;
    height: 8px;
    background: #FF3B30;
    border-radius: 50%;
    border: 1px solid white;
}

.filter-indicator.hidden {
    display: none;
}

/* Panneau Filtres intégré */
.filter-panel-integrated {
    display: none;
    margin-top: 16px;
    background: linear-gradient(135deg,
        rgba(255, 255, 255, 0.15) 0%,
        rgba(247, 250, 252, 0.12) 30%,
        rgba(255, 255, 255, 0.10) 100%);
    backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 16px;
    overflow: hidden;
    box-shadow:
        0 8px 32px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.4);
    transform: translateY(20px);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.filter-panel-integrated.show {
    display: block;
    transform: translateY(0);
    opacity: 1;
}

.filter-panel-header {
    padding: 16px 18px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    background: rgba(255, 255, 255, 0.1);
}

.filter-panel-header h4 {
    margin: 0;
    font-size: 15px;
    font-weight: 600;
    color: #1d1d1f;
}

.filter-panel-close {
    background: rgba(0, 0, 0, 0.06);
    border: none;
    border-radius: 6px;
    padding: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
    color: #86868b;
    display: flex;
    align-items: center;
    justify-content: center;
}

.filter-panel-close:hover {
    background: rgba(0, 0, 0, 0.1);
    color: #1d1d1f;
    transform: scale(1.05);
}

.filter-panel-body {
    padding: 18px;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.filter-group-integrated {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.filter-label-integrated {
    font-size: 13px;
    font-weight: 600;
    color: #1d1d1f;
    margin-bottom: 2px;
}

.filter-input-integrated {
    padding: 8px 12px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 10px;
    font-size: 13px;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    color: #1d1d1f;
}

.filter-input-integrated:hover {
    background: rgba(255, 255, 255, 0.9);
    border-color: rgba(0, 122, 255, 0.3);
}

.filter-input-integrated:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.95);
    border-color: rgba(0, 122, 255, 0.5);
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
}

/* Supprimer les flèches des inputs number */
.montant-valeur-integrated::-webkit-outer-spin-button,
.montant-valeur-integrated::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.montant-valeur-integrated[type=number] {
    -moz-appearance: textfield;
}

.montant-filter-container-integrated {
    display: flex;
    gap: 6px;
    align-items: center;
}

.montant-operateur-integrated {
    flex: 0 0 70px;
}

.montant-valeur-integrated {
    flex: 1;
}

.filter-panel-footer {
    padding: 12px 18px;
    border-top: 1px solid rgba(0, 0, 0, 0.06);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    background: rgba(255, 255, 255, 0.05);
}

.filter-reset-btn-integrated {
    background: rgba(212, 0, 0, 0.1);
    border: 1px solid rgba(212, 0, 0, 0.3);
    color: #d40000;
    padding: 8px 12px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    display: flex;
    align-items: center;
    gap: 4px;
}

.filter-reset-btn-integrated:hover {
    background: rgba(212, 0, 0, 0.15);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(212, 0, 0, 0.2);
}

.filter-apply-btn-integrated {
    background: #006ad4;
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
}

.filter-apply-btn-integrated:hover {
    background: #0051a3;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 106, 212, 0.3);
}

        .filter-group label {
            font-size: 11px;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            margin-bottom: 5px;
            display: block;
            letter-spacing: 0.5px;
        }

        .filter-input {
            width: 100%;
            padding: 7px 11px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            transition: border-color 0.2s ease;
        }

.filter-input:focus {
    outline: none;
    border-color: #9ca3af;
    box-shadow: 0 0 0 3px rgba(156, 163, 175, 0.15);
}

        .search-keywords-input {
            width: 100%;
            padding: 7px 11px 7px 35px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            transition: border-color 0.2s ease;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23999' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 10px center;
        }

.search-keywords-input:focus {
    outline: none;
    border-color: #9ca3af;
    box-shadow: 0 0 0 3px rgba(156, 163, 175, 0.15);
}

        .montant-filter-container {
            display: flex;
            gap: 6px;
        }

        .montant-operateur {
            width: 70px;
            padding: 7px 6px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 12px;
            background: white;
        }

        .montant-valeur {
            width: 80px;
            padding: 7px 8px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 13px;
            background: white;
        }

        .montant-valeur::-webkit-outer-spin-button,
        .montant-valeur::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .montant-valeur[type=number] {
            -moz-appearance: textfield;
        }

        #montant-valeur2 {
            display: none;
            width: 80px;
        }

.transaction-item {
    display: grid;
    grid-template-columns: 80px 1fr 120px;
    gap: 15px;
    align-items: center;
    padding: 12px 20px 12px 15px;
    border-bottom: 1px solid #f5f5f7;
    transition: all 0.2s ease;
    min-height: 50px;
}

        .transaction-item:hover {
            background: #f9f9fb;
        }

.transaction-banque {
    font-family: 'SF Mono', Monaco, monospace;
    font-weight: 400;
    font-size: 13px;
    color: #86868b;
    position: relative;
    cursor: help;
}

        .transaction-libelle {
            font-weight: 500;
            font-size: 13px;
            color: #1d1d1f;
            line-height: 1.4;
            cursor: text;
        }

.keyword-highlight {
    background: #cdd5f8;
    color: black;
    padding: 2px 4px;
    border-radius: 4px;
    font-weight: 600;
}

.keyword-highlight-2 {
    background: #f8cddc;
    color: black;
    padding: 2px 4px;
    border-radius: 4px;
    font-weight: 600;
}

        .transaction-montant {
            text-align: right;
            font-weight: 600;
            font-size: 13px;
        }

.montant-positif { color: #3c763d; }  /* Vert olive désaturé au lieu de #00ac56 */
.montant-negatif { color: #a94442; }  /* Rouge brique désaturé au lieu de #d40000 */

.pagination-container {
    padding: 10px 20px;
    border-top: 1px solid #e5e5ea;
    background: #f9f9fb;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 13px;
}

#transactions-count-display {
    color: #5b7290;
    font-weight: 600;
}

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pagination-select {
            padding: 5px 8px;
            border: 1px solid #d2d2d7;
            border-radius: 6px;
            font-size: 12px;
            background: white;
        }

.transactions-count-bubble {
    position: relative;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 20px;
    padding: 8px 16px;
    overflow: hidden;
    box-shadow:
        0 4px 16px rgba(66, 133, 244, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.4);
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    display: inline-block;
}

.transactions-count-bubble:hover {
    transform: translateY(-1px);
    box-shadow:
        0 6px 20px rgba(66, 133, 244, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.bubble-specular-highlight {
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent 40%,
        rgba(255, 255, 255, 0.12) 50%,
        transparent 60%
    );
    animation: bubbleSpecularMove 6s ease-in-out infinite;
    pointer-events: none;
    opacity: 0.7;
}

@keyframes bubbleSpecularMove {
    0%, 100% {
        transform: translate(-40%, -40%) rotate(45deg);
        opacity: 0.5;
    }
    50% {
        transform: translate(40%, 40%) rotate(45deg);
        opacity: 0.9;
    }
}

.bubble-content {
    position: relative;
    z-index: 2;
    color: #4285F4;
    font-weight: 600;
    font-size: 13px;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.3);
}

@media (prefers-color-scheme: dark) {
    .transactions-count-bubble {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
    }
}

        .rules-panel {
            padding: 18px;
        }

        .impact-display {
            background: #D6E4FB;
            padding: 12px;
            border-radius: 16px;
            margin-bottom: 18px;
            text-align: center;
        }

        .impact-value {
            font-size: 28px;
            font-weight: 700;
            color: #4285F4;
            margin-bottom: 6px;
        }

        .impact-label {
            font-size: 14px;
            color: #4285F4;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .create-rule-btn {
            background: #4285F4;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 12px;
            font-weight: 600;
            width: 100%;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(66, 133, 244, 0.2);
        }

        .create-rule-btn:hover {
            background: #3367D6;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }

/* Apple Intelligence / Liquid Glass Design avec effet nacré */
.impact-display-liquid {
    margin-bottom: 18px;
}

.liquid-glass-container {
    position: relative;
    background: linear-gradient(135deg,
        rgba(255, 255, 255, 0.15) 0%,
        rgba(247, 250, 252, 0.12) 15%,
        rgba(219, 234, 254, 0.08) 30%,
        rgba(236, 254, 255, 0.10) 45%,
        rgba(254, 240, 138, 0.06) 60%,
        rgba(254, 215, 170, 0.08) 75%,
        rgba(251, 207, 232, 0.10) 90%,
        rgba(255, 255, 255, 0.12) 100%);
    backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 20px;
    padding: 12px;
    text-align: center;
    overflow: hidden;
    box-shadow:
        0 8px 32px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.4),
        inset 0 -1px 0 rgba(255, 255, 255, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
}

.liquid-glass-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg,
        rgba(255, 255, 255, 0.4) 0%,
        transparent 20%,
        rgba(168, 85, 247, 0.05) 40%,
        rgba(59, 130, 246, 0.08) 60%,
        transparent 80%,
        rgba(255, 255, 255, 0.3) 100%);
    border-radius: 20px;
    opacity: 0.6;
    pointer-events: none;
}

.liquid-glass-container:hover {
    transform: translateY(-2px);
    background: linear-gradient(135deg,
        rgba(255, 255, 255, 0.20) 0%,
        rgba(247, 250, 252, 0.16) 15%,
        rgba(219, 234, 254, 0.12) 30%,
        rgba(236, 254, 255, 0.14) 45%,
        rgba(254, 240, 138, 0.10) 60%,
        rgba(254, 215, 170, 0.12) 75%,
        rgba(251, 207, 232, 0.14) 90%,
        rgba(255, 255, 255, 0.16) 100%);
    box-shadow:
        0 12px 40px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5),
        inset 0 -1px 0 rgba(255, 255, 255, 0.2);
}

.liquid-glass-container:hover::before {
    opacity: 0.8;
}

.specular-highlight {
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent 40%,
        rgba(255, 255, 255, 0.08) 50%,
        transparent 60%
    );
    animation: specularMove 8s ease-in-out infinite;
    pointer-events: none;
    opacity: 0.6;
}

@keyframes specularMove {
    0%, 100% { transform: translate(-30%, -30%) rotate(45deg); }
    50% { transform: translate(30%, 30%) rotate(45deg); }
}
.impact-content {
    position: relative;
    z-index: 2;
}

.impact-value-modern {
    font-size: 28px;
    font-weight: 700;
    color: #6b7280;
    margin-bottom: 6px;
    letter-spacing: -0.02em;
}

.impact-label-modern {
    font-size: 14px;
    color: #6b7280;
    font-weight: 600;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    justify-content: center;
}
@media (prefers-color-scheme: dark) {
    .liquid-glass-container {
        background: linear-gradient(135deg,
            rgba(255, 255, 255, 0.1) 0%,
            rgba(255, 255, 255, 0.03) 50%,
            rgba(255, 255, 255, 0.08) 100%);
        border-color: rgba(255, 255, 255, 0.15);
    }
}

/* Bouton Créer une règle - Style Liquid Glass */
.create-rule-btn-liquid {
    position: relative;
    background: #00d4d4;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 16px;
    padding: 12px 18px;
    width: 100%;
    margin-bottom: 15px;
    cursor: pointer;
    overflow: hidden;
    box-shadow:
        0 2px 8px rgba(0, 212, 212, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    backdrop-filter: blur(10px);
}

.create-rule-btn-liquid:hover {
    background: #00baba;
    transform: translateY(-1px);
    box-shadow:
        0 4px 12px rgba(0, 212, 212, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
}

.btn-specular-highlight {
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent 45%,
        rgba(255, 255, 255, 0.1) 50%,
        transparent 55%
    );
animation: btnSpecularMove 8s cubic-bezier(0.4, 0.0, 0.2, 1) infinite;
    pointer-events: none;
    opacity: 0.4;
}

@keyframes btnSpecularMove {
    0% {
        transform: translate(-60%, -60%) rotate(45deg);
        opacity: 0.3;
    }
    25% {
        transform: translate(-20%, -20%) rotate(45deg);
        opacity: 0.7;
    }
    50% {
        transform: translate(20%, 20%) rotate(45deg);
        opacity: 0.8;
    }
    75% {
        transform: translate(40%, 40%) rotate(45deg);
        opacity: 0.5;
    }
    100% {
        transform: translate(-60%, -60%) rotate(45deg);
        opacity: 0.3;
    }
}

/* Bouton Créer une règle - Version corrigée */
.create-rule-btn-liquid {
    position: relative;
    background: #e5e5ea; /* Couleur neutre par défaut */
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 16px;
    padding: 12px 18px;
    width: 100%;
    margin-bottom: 15px;
    cursor: pointer;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    backdrop-filter: blur(10px);
}

.btn-content {
    position: relative;
    z-index: 2;
    color: #1d1d1f; /* Texte sombre par défaut */
    font-weight: 600;
    font-size: 16px;
    text-align: center;
    display: block;
    width: 100%;
}

.btn-progress-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 6px; /* Plus épais */
    background: rgba(0, 212, 212, 0.8);
    border-radius: 0 0 16px 16px;
    width: 0%;
    transition: width 0.3s ease;
    z-index: 1;
    display: none; /* Masqué par défaut */
}

/* États dynamiques selon l'impact */
.create-rule-btn-liquid.btn-neutral {
    background: #e5e5ea;
    color: #1d1d1f;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.create-rule-btn-liquid.btn-low-impact {
    background: #a8a8a8;
    color: white;
    box-shadow: 0 2px 8px rgba(168, 168, 168, 0.2);
}

.create-rule-btn-liquid.btn-high-impact {
    background: #00d4d4;
    color: white;
    box-shadow: 0 2px 8px rgba(0, 212, 212, 0.2);
}

/* Aura subtile pour impact > 90% sans collision */
.create-rule-btn-liquid.btn-aura {
    box-shadow: 
        0 2px 8px rgba(0, 212, 212, 0.2),
        0 0 20px rgba(0, 212, 212, 0.25),
        0 0 40px rgba(0, 212, 212, 0.15);
}

.create-rule-btn-liquid:hover {
    transform: translateY(-1px);
}

.btn-content {
    position: relative;
    z-index: 2;
    color: white;
    font-weight: 600;
    font-size: 16px;
}

        .collision-info {
            font-size: 15px;
            text-align: center;
            color: #FBBC05;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

.collision-info.hidden {
    display: none;
}

.collision-alert {
    background: rgba(255, 204, 0, 0.1);
    border: 1px solid rgba(255, 204, 0, 0.3);
    border-radius: 16px;
    padding: 16px;
    margin-top: 12px;
    backdrop-filter: blur(20px) saturate(180%);
    box-shadow:
        0 4px 16px rgba(255, 204, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    overflow: hidden;
    position: relative;
}

.collision-alert:hover {
    transform: translateY(-1px);
    box-shadow:
        0 6px 20px rgba(255, 204, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.4);
    background: rgba(255, 204, 0, 0.15);
}

.collision-alert::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent 40%,
        rgba(255, 255, 255, 0.1) 50%,
        transparent 60%
    );
    animation: collisionSpecularMove 8s ease-in-out infinite;
    pointer-events: none;
    opacity: 0.6;
}

@keyframes collisionSpecularMove {
    0%, 100% {
        transform: translate(-30%, -30%) rotate(45deg);
        opacity: 0.4;
    }
    50% {
        transform: translate(30%, 30%) rotate(45deg);
        opacity: 0.8;
    }
}

/* REMPLACER le CSS existant de .collision-smart-alert par ceci : */
.collision-smart-alert {
    background: #fff7ed;
    border: 1px solid rgba(251, 191, 36, 0.2);
    border-left: 4px solid #fbbf24;
    border-radius: 0.5rem;
    padding: 0;
    margin-top: 1rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
    cursor: pointer;
    transition: all 0.2s ease;
    overflow: hidden;
}

.collision-smart-alert:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
    background: #fef3e2;
    border-color: rgba(251, 191, 36, 0.3);
}

.collision-smart-content {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 1rem;
}

.collision-icon-wrapper {
    width: 2rem;
    height: 2rem;
    background: #fbbf24;
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.collision-icon-wrapper svg {
    color: white;
    width: 1.25rem;
    height: 1.25rem;
}

.collision-text-section {
    flex: 1;
    min-width: 0;
}

.collision-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: #92400e;
    margin-bottom: 0.25rem;
    line-height: 1.3;
}

.collision-description {
    font-size: 0.8125rem;
    color: #92400e;
    line-height: 1.4;
    margin-bottom: 0.5rem;
}

.collision-percentage-text {
    font-weight: 700;
    color: #d97706;
    background: rgba(251, 191, 36, 0.15);
    padding: 0.125rem 0.375rem;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.collision-percentage-text:hover {
    background: rgba(251, 191, 36, 0.25);
    color: #b45309;
}

.collision-cta {
    font-size: 0.75rem;
    font-weight: 600;
    color: #d97706;
    display: flex;
    align-items: center;
    gap: 0.25rem;
    cursor: pointer;
    transition: color 0.2s ease;
    text-transform: none;
    letter-spacing: 0;
}

.collision-cta:hover {
    color: #b45309;
}

.collision-cta svg {
    transition: transform 0.2s ease;
}

.collision-cta:hover svg {
    transform: translateX(2px);
}

.collision-smart-alert.hidden {
    display: none;
}

        /* Styles pour le modal de collision */
        .collision-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .collision-modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 80%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .collision-modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #f5f5f7;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            flex-shrink: 0;
        }

        .collision-modal-title {
            font-weight: 600;
            color: #1d1d1f;
            margin: 0;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .collision-modal-body {
            padding: 20px 30px;
            overflow-y: auto;
            flex: 1;
            background: #fafafa;
        }

        .collision-compte-group {
            margin-bottom: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .collision-compte-header {
            padding: 15px 20px;
            background: #f9f9fb;
            border-bottom: 1px solid #e5e5ea;
            font-weight: 600;
            font-size: 14px;
            color: #1d1d1f;
            transition: background 0.2s ease;
        }

        .collision-compte-header:hover {
            background: #f0f0f2;
        }

        .collision-transactions-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .collision-transactions-table th {
            background: #f9f9fb;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #86868b;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e5e5ea;
        }

        .collision-transactions-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #f5f5f7;
            vertical-align: top;
        }

        .collision-transactions-table tr:hover {
            background: #f9f9fb;
        }

        .collision-banque {
            font-family: 'SF Mono', Monaco, monospace;
            font-weight: 500;
            color: #1d1d1f;
        }

        .collision-libelle {
            color: #1d1d1f;
            line-height: 1.4;
        }

        .collision-montant {
            text-align: right;
            font-weight: 600;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .collision-montant.positif {
            color: #34A853;
        }

        .collision-montant.negatif {
            color: #EA4335;
        }

        .collision-keyword-highlight {
            background: #f09e65;
            color: black;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
        }

        /* Code à ajouter dans la section <style> */
.collision-keyword-highlight-2 {
    background: #65c3f0;
    color: black;
    padding: 2px 4px;
    border-radius: 4px;
    font-weight: 600;
}

        .collision-chevron {
            transition: transform 0.2s ease;
        }

        .collision-chevron.rotated {
            transform: rotate(180deg);
        }

        @media (max-width: 1400px) {
            .main-container {
                grid-template-columns: 1fr;
                height: auto;
            }

            .panel {
                margin-bottom: 20px;
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

.modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(8px);
    animation: modalFadeIn 0.3s ease;
}

@keyframes modalFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background: linear-gradient(135deg,
        rgba(255, 255, 255, 0.98) 0%,
        rgba(248, 250, 252, 0.95) 100%);
    backdrop-filter: blur(20px) saturate(150%);
    margin: 8% auto;
    padding: 0;
    border-radius: 20px;
    width: 210px;
    max-width: 90%;
    box-shadow: 
        0 25px 80px rgba(0, 0, 0, 0.15),
        0 0 0 1px rgba(255, 255, 255, 0.4);
    animation: modalSlideIn 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
    overflow: hidden;
}

@keyframes modalSlideIn {
    from { 
        opacity: 0; 
        transform: translateY(-20px) scale(0.95); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
    }
}

.modal-header {
    padding: 16px 20px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255, 255, 255, 0.6);
}

.modal-title {
    font-weight: 600;
    color: #1d1d1f;
    margin: 0;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}


.modal-title svg {
    color: #64748b;
}

.btn-close {
    background: rgba(100, 116, 139, 0.1);
    border: none;
    border-radius: 8px;
    width: 32px;
    height: 32px;
    cursor: pointer;
    color: #64748b;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-close:hover {
    background: rgba(100, 116, 139, 0.2);
    color: #334155;
    transform: scale(1.05);
}

.modal-body {
    padding: 20px;
}

.upload-zone {
    border: 2px dashed #d1d5db;
    border-radius: 12px;
    padding: 75px 1px;
    text-align: center;
    background: rgba(249, 250, 251, 0.8);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.upload-zone::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent 40%,
        rgba(156, 163, 175, 0.05) 50%,
        transparent 60%
    );
    transform: translateX(-100%) translateY(-100%) rotate(45deg);
    transition: transform 0.6s ease;
}

.upload-zone:hover::before {
    transform: translateX(100%) translateY(100%) rotate(45deg);
}

.upload-zone:hover {
    border-color: #9ca3af;
    background: rgba(243, 244, 246, 0.9);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.upload-zone.dragover {
    border-color: #6b7280;
    background: rgba(229, 231, 235, 0.9);
    transform: scale(1.02);
}

.upload-icon {
    color: #9ca3af;
    margin-bottom: 16px;
    transition: all 0.3s ease;
}

.upload-zone:hover .upload-icon {
    color: #6b7280;
    transform: scale(1.1);
}

.upload-content h5 {
    color: #374151;
    font-weight: 600;
    margin-bottom: 6px;
    font-size: 14px;
}

.upload-content p {
    color: #6b7280;
    margin-bottom: 8px;
    font-size: 12px;
}

.browse-link {
    color: #6b7280;
    font-weight: 600;
    text-decoration: underline;
    cursor: pointer;
}

.browse-link:hover {
    color: #374151;
}

.upload-content small {
    color: #9ca3af;
    font-size: 10px;
}

.file-info {
    padding: 20px;
}

.success-icon {
    color: #10b981;
    margin-bottom: 16px;
}

.file-info h5 {
    color: #374151;
    font-weight: 600;
    margin-bottom: 8px;
}

.file-info p {
    color: #6b7280;
    font-size: 14px;
}

.progress-container {
    display: none;
    margin-top: 24px;
    padding: 20px;
    background: rgba(249, 250, 251, 0.6);
    border-radius: 12px;
    border: 1px solid rgba(0, 0, 0, 0.06);
}

.progress-bar-container {
    background: rgba(229, 231, 235, 0.8);
    border-radius: 8px;
    height: 6px;
    overflow: hidden;
    margin-bottom: 12px;
    position: relative;
}

.progress-bar {
    background: linear-gradient(90deg, #6b7280, #9ca3af);
    height: 100%;
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 8px;
}

.progress-text {
    color: #6b7280;
    font-size: 13px;
    font-weight: 500;
    text-align: center;
}

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            padding: 16px 20px;
            display: none;
            z-index: 9999;
            border-left: 4px solid #28c840;
        }

        .toast-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast-icon {
            color: #28c840;
            font-size: 20px;
        }

        .toast-text {
            color: #1d1d1f;
            font-weight: 500;
        }

        .logo-container {
            margin-left: 0;
            padding-left: 0;
        }

        .logo-company-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Styles pour l'état vide/chargement */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #86868b;
        }

        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, transparent 37%, #f0f0f0 63%);
            background-size: 400% 100%;
            animation: loading 1.4s ease infinite;
            border-radius: 8px;
            height: 20px;
            margin-bottom: 8px;
        }

@keyframes loading {
            0% { background-position: 100% 50%; }
            100% { background-position: -100% 50%; }
        }

        .collision-compte-header:hover {
            background: #f9f9fb !important;
        }

        .collision-chevron.rotated {
            transform: rotate(180deg);
        }

        .collision-transactions-table {
            transition: all 0.3s ease;
        }

     /* Styles pour le conteneur de recherche simplifié */
.search-container-simple {
    padding: 12px 20px;
    background: #f9f9fb;
    border-bottom: 1px solid #e5e5ea;
}

.search-keywords-input-modern {
    width: 100%;
    padding: 10px 16px 10px 40px;
    border: 1px solid #d2d2d7;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 400;
    color: #1d1d1f;
    outline: none;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23999' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: 12px center;
}

/* Styles pour le conteneur de filtres permanent */
.filters-container-permanent {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(247, 250, 252, 0.12) 100%);
    backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 16px;
    margin-bottom: 16px;
    overflow: hidden;
}

.filters-header {
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
}

.filters-header h4 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    color: #1d1d1f;
}

.filters-body {
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.filter-group-permanent {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.filter-label-permanent {
    font-size: 12px;
    font-weight: 600;
    color: #1d1d1f;
}

.filter-input-permanent {
    padding: 6px 10px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    font-size: 12px;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    color: #1d1d1f;
}

.filter-input-permanent:focus {
    outline: none;
    border-color: rgba(0, 122, 255, 0.5);
    box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.1);
}

.checkbox-label-permanent {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    color: #1d1d1f;
}

.checkbox-label-permanent input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: #007aff;
}

.montant-filter-permanent {
    display: flex;
    gap: 6px;
    align-items: center;
}

.filter-reset-btn-permanent {
    background: rgba(212, 0, 0, 0.1);
    border: 1px solid rgba(212, 0, 0, 0.3);
    color: #d40000;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 8px;
}

.filter-reset-btn-permanent:hover {
    background: rgba(212, 0, 0, 0.15);
    transform: translateY(-1px);
}

.transaction-groups-container {
    margin-bottom: 20px;
}

.automation-glass-background-suggestions {
    position: relative;
    background: linear-gradient(135deg,
        rgba(102, 126, 234, 0.1) 0%,
        rgba(118, 75, 162, 0.08) 50%,
        rgba(102, 126, 234, 0.12) 100%);
    backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(102, 126, 234, 0.2);
    border-radius: 12px;
    padding: 16px;
    overflow: hidden;
    box-shadow:
        0 2px 8px rgba(102, 126, 234, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.4);
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
}

.automation-glass-background-suggestions:hover {
    transform: translateY(-1px);
    box-shadow:
        0 4px 12px rgba(102, 126, 234, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.automation-content-suggestions {
    position: relative;
    z-index: 2;
    display: flex;
    align-items: center;
    font-size: 14px;
    font-weight: 600;
    color: #667eea;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.3);
    margin-bottom: 12px;
}

.groups-list {
    position: relative;
    z-index: 2;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.group-item {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(250, 250, 252, 0.98) 100%);
    border: 1px solid rgba(102, 126, 234, 0.2);
    border-radius: 10px;
    padding: 10px 12px;
    cursor: pointer;
    transition: all 0.25s ease;
    position: relative;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(102, 126, 234, 0.08);
    backdrop-filter: blur(10px);
}

.group-item:hover {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(245, 247, 255, 1) 100%);
    border-color: rgba(102, 126, 234, 0.3);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
}

.group-item.selected {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.12) 0%, rgba(118, 75, 162, 0.08) 100%);
    border-color: rgba(102, 126, 234, 0.4);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
}

.group-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 4px;
}

.group-pattern {
    font-size: 13px;
    font-weight: 700;
    color: #3d4a95;
    line-height: 1.3;
    flex: 1;
    margin-right: 8px;
}

.group-percentage {
    font-size: 12px;
    font-weight: 700;
    color: #667eea;
    background: rgba(102, 126, 234, 0.2);
    padding: 2px 6px;
    border-radius: 6px;
    white-space: nowrap;
}

.group-stats {
    font-size: 11px;
    color: #667eea;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.group-stats-left {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
}

.empty-groups-state {
    text-align: center;
    padding: 16px;
    color: #667eea;
    font-size: 13px;
    font-style: italic;
}

    </style>
</head>
<body>

<!-- Inclusion de la sidebar -->
    {% set current_page = 'create_rule' if request.args.get('mode') == 'create_rule' else 'dashboard' %}
    {% include 'includes/sidebar.html' %}
<!-- Modal Upload FEC -->
<div class="modal" id="uploadModal">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0M9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1M4 1.5h5v2a2 2 0 0 0 2 2h2v8a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5"/>
                </svg>
                Importer un fichier FEC
            </h5>
            <button type="button" class="btn-close" onclick="closeUploadModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                <div class="upload-content" id="uploadContent">
                    <div class="upload-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/>
                            <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1z"/>
                        </svg>
                    </div>
                    <h5>Glissez votre fichier FEC ici</h5>
                    <p>ou <span class="browse-link">cliquez pour parcourir</span></p>
                    <small>Formats acceptés : .txt, .csv • Max 100 MB</small>
                </div>
                <div class="file-info" id="fileInfo" style="display: none;">
                    <div class="success-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                        </svg>
                    </div>
                    <h5 id="fileName"></h5>
                    <p id="fileSize"></p>
                </div>
            </div>
            <input type="file" id="fileInput" accept=".txt,.csv" style="display: none;" onchange="handleFileSelect(this.files)">

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="progress-text" id="progressText">Traitement en cours...</div>
            </div>
        </div>
    </div>
</div>

    <!-- Interface principale -->
    <div class="main-container">
        <!-- GAUCHE : Comptes (3 colonnes avec recherche) -->
        <div class="panel">
            <div class="panel-header">
                Comptes de contrepartie
            </div>

<div class="search-container">
    <div class="search-wrapper">
        <input type="text" class="search-input" id="compte-search" placeholder="Rechercher un compte..." autocomplete="off" oninput="filtrerComptes(); updateClearButton();">
        <button class="search-clear-btn" id="compte-search-clear" onclick="clearCompteSearch()" style="display: none;" title="Effacer la recherche">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/>
            </svg>
        </button>
    </div>
</div>

<div class="comptes-header">
                <div class="sortable-header" onclick="trierComptes('compte')">
                    Compte
                    <span class="sort-icon" id="sort-icon-compte"></span>
                </div>
                <div class="sortable-header" onclick="trierComptes('gain')">
                    Gain potentiel
                    <span class="sort-icon" id="sort-icon-gain"></span>
                </div>
            </div>

            <div class="panel-body" id="comptes-list">
                <!-- Les comptes seront injectés ici par JavaScript -->
                <div class="empty-state" id="comptes-empty">
                    <div>📊</div>
                    <p>Aucun compte disponible</p>
                    <small>Importez un fichier FEC pour commencer</small>
                </div>
            </div>
        </div>

        <!-- CENTRE : Transactions (3 colonnes avec tri) -->
        <div class="panel">
<div class="panel-header">
    Transactions bancaires
</div>

<div class="search-container">
    <div class="search-wrapper" style="gap: 8px;">
        <input type="text" class="search-input" id="search-keywords"
               placeholder="Rechercher des mots-clés..." autocomplete="off" oninput="filtrerTransactions()"
               onkeydown="handleKeywordsKeydown(event)" onblur="handleKeywordsBlur()"
               style="flex: 1;">
        <input type="text" class="search-input" id="search-keywords-2"
               placeholder="ET également..." autocomplete="off" oninput="filtrerTransactions()"
               style="display: none; flex: 1;">
    </div>
</div>

<div class="transactions-header">
    <div class="sortable-transaction-header" onclick="trierTransactions('banque')">
        Banque
        <span class="sort-icon-transaction" id="sort-icon-transaction-banque"></span>
    </div>
    <div class="sortable-transaction-header" onclick="trierTransactions('libelle')">
        Libellé de transaction
        <span class="sort-icon-transaction" id="sort-icon-transaction-libelle"></span>
    </div>
    <div class="sortable-transaction-header" onclick="trierTransactions('montant')">
        Montant
        <span class="sort-icon-transaction" id="sort-icon-transaction-montant"></span>
    </div>
</div>

            <div class="panel-body" id="transactions-container">
                <div class="empty-state" id="transactions-empty">
                    <div>💳</div>
                    <p>Sélectionnez un compte pour voir les transactions</p>
                </div>
            </div>

<div class="pagination-container">
                <div class="transactions-count-bubble">
                    <div class="bubble-specular-highlight"></div>
                    <div class="bubble-content" id="transactions-count-display">0 transaction</div>
                </div>
<div class="pagination-controls" style="margin-left: auto;">
                    <span>Afficher:</span>
<select class="pagination-select" id="pagination-select" onchange="changePagination()">
<option value="50">50</option>
<option value="100" selected>100</option>
                        <option value="100">100</option>
                        <option value="300">300</option>
                        <option value="all">∞</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- DROITE : Règles simplifié -->
        <div class="panel">
            <div class="rules-panel">

<!-- Filtres avancés collapsibles Apple Intelligence -->
<div class="filters-container-ai">
    <div class="filters-header-ai" onclick="toggleFiltersAI()">
        <div class="filters-title-ai">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="filter-icon-ai" viewBox="0 0 16 16">
                <path d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5m-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5"/>
            </svg>
            <span>Filtres avancés</span>
        </div>
        <svg class="filters-chevron-ai" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708"/>
        </svg>
        <div class="filters-specular-highlight"></div>
    </div>

<div class="filters-body-ai" id="filters-body-ai" style="display: none;">
    <div class="filter-group-ai">
        <label class="checkbox-label-ai">
            <input type="checkbox" id="show-covered-transactions" onchange="filtrerTransactions();">
            <span class="checkbox-text-ai">Afficher transactions traitées</span>
        </label>
    </div>

    <div class="filter-group-ai">
        <label class="filter-label-ai">Banque</label>
        <select class="filter-input-ai" id="filter-banque" onchange="filtrerTransactions();">
            <option value="">Toutes les banques</option>
        </select>
    </div>

    <div class="filter-group-ai">
        <label class="filter-label-ai">Montant</label>
        <div class="montant-filter-ai">
            <select class="filter-input-ai filter-input-small-ai" id="montant-operateur" onchange="filtrerTransactions(); toggleMontantSecond();">
                <option value="=" selected>=</option>
                <option value="!=">≠</option>
                <option value="<"><</option>
                <option value=">">></option>
                <option value="<=">≤</option>
                <option value=">=">≥</option>
                <option value="entre">Entre</option>
            </select>
            <input type="number" class="filter-input-ai" id="montant-valeur"
                   placeholder="Montant" autocomplete="off" onchange="filtrerTransactions();">
            <input type="number" class="filter-input-ai" id="montant-valeur2"
                   placeholder="Et" autocomplete="off" onchange="filtrerTransactions();" style="display: none;">
        </div>
    </div>
</div>
</div>

<button class="create-rule-btn-liquid impact-dynamic-btn" id="create-rule-btn" onclick="creerNouvelleRegle()" style="display: none;">
    <div class="btn-specular-highlight"></div>
    <div class="btn-content">
        <span class="btn-text">Créer une nouvelle règle</span>
    </div>
    <div class="btn-progress-bar" id="btn-progress-bar"></div>
</button>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Inclusion des styles communs -->
    {% include 'includes/common_styles.html' %}

<style>
/* Apple Intelligence Filter Design - Compact */
.filters-container-ai {
    background: linear-gradient(135deg,
        rgba(255, 255, 255, 0.15) 0%,
        rgba(247, 250, 252, 0.12) 100%);
    backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 14px;
    margin-bottom: 16px;
    overflow: hidden;
    position: relative;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
}

.filters-container-ai.expanded {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.filters-header-ai {
    padding: 12px 16px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.2s ease;
}

.filters-header-ai:hover {
    background: linear-gradient(135deg,
        rgba(255, 255, 255, 0.12) 0%,
        rgba(247, 250, 252, 0.08) 100%);
}

.filters-specular-highlight {
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent 40%,
        rgba(255, 255, 255, 0.06) 50%,
        transparent 60%
    );
    animation: filtersSpecularMove 6s ease-in-out infinite;
    pointer-events: none;
    opacity: 0.8;
}

@keyframes filtersSpecularMove {
    0%, 100% { transform: translate(-30%, -30%) rotate(45deg); }
    50% { transform: translate(30%, 30%) rotate(45deg); }
}

.filters-title-ai {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    font-weight: 600;
    color: #6b7280;
    letter-spacing: -0.02em;
    z-index: 2;
    position: relative;
}

.filter-icon-ai {
    color: #86868b;
    opacity: 1;
    filter: drop-shadow(0 1px 2px rgba(134, 134, 139, 0.3));
}

.filters-chevron-ai {
    color: #86868b;
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    z-index: 2;
    position: relative;
}

.filters-chevron-ai.expanded {
    transform: rotate(180deg);
    color: #86868b;
}

/* Filtre avancé avec design cohérent */
.filters-body-ai {
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    border-top: 1px solid rgba(0, 0, 0, 0.06);
background-color: #fafafa; /* gris clair Tailwind */
    border-radius: 0 0 14px 14px;
    animation: filtersBodyExpand 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

/* Animation d'expansion */
@keyframes filtersBodyExpand {
    0% {
        opacity: 0;
        transform: translateY(-10px);
        max-height: 0;
    }
    100% {
        opacity: 1;
        transform: translateY(0);
        max-height: 300px;
    }
}

.filter-group-ai {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.filter-label-ai {
    font-size: 12px;
    font-weight: 600;
    color: #374151;
    letter-spacing: -0.01em;
    margin-bottom: 4px;
}

.filter-input-ai {
    padding: 10px 12px;
    border: 1px solid rgba(156, 163, 175, 0.3);
    border-radius: 8px;
    font-size: 13px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    color: #374151;
    font-weight: 400;
    outline: none;
}

.filter-input-ai:hover {
    background: rgba(255, 255, 255, 0.95);
    border-color: rgba(156, 163, 175, 0.5);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(156, 163, 175, 0.15);
}

.filter-input-ai:focus {
    background: rgba(255, 255, 255, 1);
    border-color: #9ca3af;
    box-shadow: 0 0 0 3px rgba(156, 163, 175, 0.15);
}

.filter-input-ai::placeholder {
    color: #9ca3af;
    font-weight: 400;
}

/* Masquer les flèches des inputs number */
.filter-input-ai[type=number]::-webkit-outer-spin-button,
.filter-input-ai[type=number]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.filter-input-ai[type=number] {
    -moz-appearance: textfield;
}

.filter-input-small-ai {
    flex: 0 0 65px;
}

.checkbox-label-ai {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    padding: 6px 0;
    transition: all 0.2s ease;
}

.checkbox-label-ai:hover {
    transform: translateX(2px);
}

/* Case à cocher avec accent gris */
.checkbox-label-ai {
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    padding: 8px 0;
    transition: all 0.2s ease;
}

.checkbox-label-ai input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: #6b7280;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.checkbox-text-ai {
    font-size: 13px;
    font-weight: 500;
    color: #374151;
    letter-spacing: -0.01em;
}

.montant-filter-ai {
    display: flex;
    gap: 10px;
    align-items: center;
}

.montant-filter-ai .filter-input-ai:not(.filter-input-small-ai) {
    flex: 1;
}

/* Styles pour le bouton dynamique avec impact */
.impact-dynamic-btn .btn-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
}

.btn-text {
    font-weight: 600;
    font-size: 16px;
}

.btn-impact {
    font-size: 12px;
    opacity: 0.8;
    font-weight: 500;
}

.btn-progress-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 12px;
    border-radius: 0 0 16px 16px;
    width: 0%;
    transition: all 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
    z-index: 1;
    display: none;
    /* Couleur définie dynamiquement par JavaScript */
}

/* Progression turquoise pour règles excellentes (+90%) */
.create-rule-btn-liquid.btn-excellent {
    color: white;
    animation: pulse-excellence 2s ease-in-out infinite;
}

@keyframes pulse-excellence {
    0%, 100% { 
        transform: scale(1);
    }
    50% { 
        transform: scale(1.02);
    }
}

/* Effets visuels pour seuils élevés */
.impact-high-80 {
    animation: pulse-subtle 2s infinite;
    background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
}

.impact-high-90 {
    animation: vibrate-glow 1.5s infinite;
    background: linear-gradient(135deg, #FF9800 0%, #FFB74D 100%);
    box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
}

.impact-ultra-95 {
    animation: pulse-intense 1s infinite, vibrate-glow 0.8s infinite;
    background: linear-gradient(135deg, #F44336 0%, #EF5350 100%);
    box-shadow: 0 8px 25px rgba(244, 67, 54, 0.5);
}

/* Animations */
@keyframes pulse-subtle {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
}

@keyframes vibrate-glow {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-1px); }
    75% { transform: translateX(1px); }
}

@keyframes pulse-intense {
    0%, 100% { transform: scale(1); box-shadow: 0 8px 25px rgba(244, 67, 54, 0.5); }
    50% { transform: scale(1.05); box-shadow: 0 12px 35px rgba(244, 67, 54, 0.7); }
}

</style>

<script>
function toggleFiltersAI() {
    const body = document.getElementById('filters-body-ai');
    const chevron = document.querySelector('.filters-chevron-ai');
    const container = document.querySelector('.filters-container-ai');

    if (body.style.display === 'none') {
        body.style.display = 'flex';
        chevron.classList.add('expanded');
        container.classList.add('expanded');
    } else {
        body.style.display = 'none';
        chevron.classList.remove('expanded');
        container.classList.remove('expanded');
    }
}
</script>

<!-- Conteneur des groupes de transactions intelligents -->
<div class="transaction-groups-container" id="transaction-groups-container">
    <div class="automation-glass-background-suggestions">
        <div class="automation-specular-highlight"></div>

        <!-- Header du conteneur -->
        <div class="automation-content-suggestions">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stars" viewBox="0 0 16 16" style="margin-right: 6px;">
                <path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.73 1.73 0 0 0 4.593 5.69l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.69A1.73 1.73 0 0 0 2.31 4.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.73 1.73 0 0 0 3.407 2.31zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.16 1.16 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.16 1.16 0 0 0-.732-.732L9.1 2.137a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732z"/>
            </svg>
            <span style="font-size: 14px; font-weight: 600;">Suggestions de règles</span>
        </div>

        <!-- Liste des suggestions dans le même conteneur -->
        <div class="groups-list" id="groups-list">
            <!-- Les groupes seront injectés ici par JavaScript -->
            <div class="empty-groups-state" id="empty-groups-state">
                <p>Analysez les transactions pour découvrir des patterns</p>
            </div>
        </div>
    </div>
</div>

<div class="collision-smart-alert hidden" id="collision-info">
    <div class="collision-smart-content">
        <div class="collision-icon-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/>
            </svg>
        </div>
        <div class="collision-text-section">
            <div class="collision-title">Collision de règle</div>
            <div class="collision-description">
            <span class="collision-percentage-text" id="collision-percentage">0%</span>concernées dans d'autres comptes.
            </div>
            <div class="collision-cta" onclick="ouvrirModalCollision()">
                Voir les transactions en conflit
                <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708"/>
                </svg>
            </div>
        </div>
    </div>
</div>

</div>
        </div>
    </div>

</div>

    <!-- Modal Collisions -->
    <div class="collision-modal" id="collisionModal">
        <div class="collision-modal-content">
            <div class="collision-modal-header">
                <h5 class="collision-modal-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4m.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2"/>
                    </svg>
                    Détail des collisions
                </h5>
                <button type="button" class="btn-close" onclick="fermerModalCollision()">&times;</button>
            </div>
            <div class="collision-modal-body" id="collisionModalBody">
                <!-- Le contenu sera injecté par JavaScript -->
            </div>
        </div>
    </div>

    <script>

// 🚨 AJOUT DEBUG - Capturer toutes les erreurs JavaScript
window.onerror = function(msg, url, lineNo, columnNo, error) {
    console.error('🚨 ERREUR JS DÉTECTÉE:', {
        message: msg,
        source: url,
        line: lineNo,
        column: columnNo,
        error: error,
        stack: error ? error.stack : 'Pas de stack'
    });
    return false;
};

window.addEventListener('unhandledrejection', function(event) {
    console.error('🚨 PROMESSE REJETÉE:', event.reason);
});

// Variables globales dynamiques
let compteSelectionne = null;
let paginationLimit = 100; // Limite par défaut de 100 transactions
        let currentSort = { field: 'gain', direction: 'desc' };
let transactionSort = { field: null, direction: 'asc' };
        const societeId = {{ societe.id if societe else 'null' }};

        // Fonction pour récupérer le libellé d'un compte
        function getLibelleCompte(compte) {
            const compteInfo = comptesStatistiques.find(c => c.compte === compte);
            return compteInfo ? compteInfo.libelle : 'Compte ' + compte;
        }

// Données récupérées depuis le backend
        let toutesEcritures = {{ ecritures_json|safe if ecritures_json else '[]' }};
        let comptesStatistiques = {{ comptes_statistiques|safe if comptes_statistiques else '[]' }};
        let journaux = {{ journaux|safe if journaux else '[]' }};
        let automatisationGlobale = {{ automatisation_globale if automatisation_globale else 0 }};

// Données des sociétés pour le dropdown
        let toutesLesSocietes = [
            {% if societes %}
                {% for soc in societes %}
                {
                    id: {{ soc.id }},
                    nom: "{{ soc.nom|e }}",
                    siret: "{{ soc.siret|e if soc.siret else '' }}",
                    current: {{ 'true' if soc.id == societe.id else 'false' }}
                }{% if not loop.last %},{% endif %}
                {% endfor %}
            {% endif %}
        ];

        console.log('📊 Sociétés chargées:', toutesLesSocietes);

        // État actuel du filtrage
        let ecrituresFiltered = [];
        let currentFilters = {
            banque: '',
            keywords: '',
            montantOp: '=',
            montantVal: '',
            montantVal2: ''
        };
// Variable pour stocker les détails des collisions
let collisionDetails = [];

// Fonction utilitaire pour notifier les changements de règles
function notifierChangementRegles() {
    console.log('📡 Notification changement de règles...');
    localStorage.setItem('regles_modifiees', Date.now().toString());
}

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initialisation du dashboard dynamique');

            // Vérifier si nous avons des données
            if (societeId && societeId !== 'null') {
                initializeDashboard();
            } else {
                console.warn('⚠️ Aucune société sélectionnée');
                showEmptyState();
            }

            updateAutomationColor();
        });

        function initializeDashboard() {
            console.log('📊 Initialisation avec les données:', {
                societeId,
                nbEcritures: toutesEcritures.length,
                nbComptes: comptesStatistiques.length,
                nbJournaux: journaux.length
            });

            // Charger les comptes
            chargerComptes();

            // Charger les journaux dans le filtre
            chargerJournaux();

            // Sélectionner le premier compte s'il y en a
            if (comptesStatistiques.length > 0) {
                const premierCompte = comptesStatistiques[0].compte;
                selectionnerCompte(premierCompte);
            }
        }

function chargerComptes() {
    const container = document.getElementById('comptes-list');
    const emptyState = document.getElementById('comptes-empty');

    if (comptesStatistiques.length === 0) {
        container.innerHTML = '';
        container.appendChild(emptyState);
        return;
    }

    // Filtrer les comptes pour exclure ceux 100% traités
    const comptesAffichables = comptesStatistiques.filter(compte => {
        const pourcentageAFaire = parseFloat(compte.pourcentage_a_faire);
        return pourcentageAFaire > 0; // Ne garder que les comptes avec du travail à faire
    });

    console.log('📊 Comptes filtrés:', {
        total: comptesStatistiques.length,
        affichables: comptesAffichables.length,
        masques: comptesStatistiques.length - comptesAffichables.length
    });

    // Si aucun compte n'a de travail à faire, afficher un message spécial
    if (comptesAffichables.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div>🎉</div>
                <p>Tous les comptes sont 100% traités !</p>
                <small>Félicitations, l'automatisation est complète</small>
            </div>
        `;
        return;
    }

    // Cacher l'état vide
    if (emptyState) emptyState.style.display = 'none';

    let html = '';
    comptesAffichables.forEach(compte => {
        const compteNumber = formatCompteNumber(compte.compte);
// Fonction pour formater les pourcentages avec précision adaptative (données déjà formatées côté serveur)
const formatPourcentage = (valeur) => {
    const num = parseFloat(valeur);
    if (num === 0) return '0%';
    return num + '%';
};

html += `
    <div class="compte-item"
         data-compte="${compte.compte}"
         data-percentage="${compte.pourcentage_total}"
         data-gain="${compte.pourcentage_a_faire}"
         data-libelle="${compte.libelle}"
         data-nb-transactions="${compte.nb_transactions}"
         onclick="selectionnerCompte('${compte.compte}')">
        <div class="compte-info">
            <div class="compte-number">${compteNumber}</div>
            <div class="compte-libelle">${compte.libelle}</div>
        </div>
<div class="stat-afaire"
             onmouseenter="showTooltip(this, 'Traité: ${formatPourcentage(compte.pourcentage_traite)} • ${compte.nb_transactions} transactions')"
             onmouseleave="hideTooltip(this)">
            ${formatPourcentage(compte.pourcentage_a_faire)}
            <div class="tooltip-custom">Traité: ${formatPourcentage(compte.pourcentage_traite)}% • ${compte.nb_transactions} transactions</div>
        </div>
    </div>
`;
    });

container.innerHTML = html;

// Plus de tri automatique par libellé - laisser le tri intelligent s'appliquer
// Commenté : if (transactionSort.field === 'libelle') { ... }
        }

function chargerJournaux() {
    const select = document.getElementById('filter-banque');
    let options = '<option value="">Toutes</option>';

    // Trier les journaux par journal_code par ordre alphanumérique naturel croissant
    const journauxTries = [...journaux].sort((a, b) => {
        return a.journal_code.localeCompare(b.journal_code, undefined, {
            numeric: true,
            sensitivity: 'base'
        });
    });

    // Identifier les journaux qui ont des transactions dans le compte sélectionné
    const journauxAvecTransactions = [];

journauxTries.forEach(journal => {
    // Vérifier s'il y a des transactions pour ce journal dans le compte sélectionné
    const hasTransactions = compteSelectionne ?
        toutesEcritures.some(e =>
            e.compte_contrepartie === compteSelectionne &&
            e.journal_code === journal.journal_code
        ) : true;

    if (hasTransactions) {
        journauxAvecTransactions.push(journal.journal_code);
    }

    // Suppression de l'attribut disabled et du style pour rendre tout cliquable
    const style = hasTransactions ? '' : 'color: #999; font-style: italic;';
    const suffix = hasTransactions ? '' : ' (aucune transaction)';

    options += `<option value="${journal.journal_code}" style="${style}">
        ${journal.journal_code} - ${journal.journal_lib}${suffix}
    </option>`;
});

    select.innerHTML = options;

    // Auto-sélectionner si il n'y a qu'un seul journal avec des transactions
    if (journauxAvecTransactions.length === 1) {
        select.value = journauxAvecTransactions[0];
        console.log('🎯 Auto-sélection du journal unique:', journauxAvecTransactions[0]);
    } else {
        // Réinitialiser à "Toutes" si plusieurs journaux ou aucun
        select.value = '';
    }
}
        function formatCompteNumber(compte) {
            // Formater le numéro de compte : 62700000003 → 627 00000003
            if (compte.length >= 6) {
                return compte.substring(0, 3) + ' ' + compte.substring(3);
            }
            return compte;
        }

        // Mise à jour de la couleur d'automatisation selon le pourcentage
        function updateAutomationColor() {
            const automationElement = document.getElementById('automation-percentage');
            if (!automationElement) return;

            const percentageText = automationElement.textContent;
            const percentage = parseFloat(percentageText.replace('%', ''));

            automationElement.classList.remove('low', 'medium', 'high');

            if (percentage <= 30) {
                automationElement.classList.add('low');
            } else if (percentage <= 70) {
                automationElement.classList.add('medium');
            } else {
                automationElement.classList.add('high');
            }
        }

        // Gestion des tooltips
        function showTooltip(element, text) {
            const tooltip = element.querySelector('.tooltip-custom');
            if (tooltip) {
                tooltip.textContent = text;
                tooltip.style.opacity = '1';
            }
        }

        function hideTooltip(element) {
            const tooltip = element.querySelector('.tooltip-custom');
            if (tooltip) {
                tooltip.style.opacity = '0';
            }
        }

// Gestion des tooltips pour les banques
function showBanqueTooltip(element, text) {
    const tooltip = element.querySelector('.tooltip-banque');
    if (tooltip) {
        tooltip.textContent = text;
        tooltip.style.opacity = '1';

        // Forcer le recalcul de la taille du tooltip
        tooltip.style.visibility = 'hidden';
        tooltip.style.opacity = '1';

        const rect = element.getBoundingClientRect();
        const tooltipWidth = tooltip.offsetWidth;

        // Centrer le tooltip de façon à ce que le code journal soit au centre de la bulle
        const centerPosition = rect.left + (rect.width / 2) - (tooltipWidth / 2);

        tooltip.style.left = centerPosition + 'px';
        tooltip.style.top = (rect.bottom + 8) + 'px';
        tooltip.style.visibility = 'visible';
    }
}

function hideBanqueTooltip(element) {
    const tooltip = element.querySelector('.tooltip-banque');
    if (tooltip) {
        tooltip.style.opacity = '0';
    }
}

        // Tri des comptes avec gestion des icônes
        function trierComptes(field) {
            const container = document.getElementById('comptes-list');
            const items = Array.from(container.querySelectorAll('.compte-item'));

            // Gestion de la direction du tri
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = field === 'compte' ? 'asc' : 'desc';
            }

            // Mettre à jour les icônes de tri
            updateSortIcons(field, currentSort.direction);

            // Tri des éléments
            items.sort((a, b) => {
                let aValue, bValue;

                switch (field) {
                    case 'compte':
                        aValue = a.dataset.compte;
                        bValue = b.dataset.compte;
                        break;
                    case 'percentage':
                        aValue = parseFloat(a.dataset.percentage);
                        bValue = parseFloat(b.dataset.percentage);
                        break;
                    case 'gain':
                        aValue = parseFloat(a.dataset.gain);
                        bValue = parseFloat(b.dataset.gain);
                        break;
                }

                if (currentSort.direction === 'asc') {
                    return aValue > bValue ? 1 : -1;
                } else {
                    return aValue < bValue ? 1 : -1;
                }
            });

            items.forEach(item => container.appendChild(item));
        }

        // Fonction pour mettre à jour les icônes de tri
        function updateSortIcons(activeField, direction) {
            const allIcons = document.querySelectorAll('.sort-icon');
            allIcons.forEach(icon => {
                icon.classList.remove('asc', 'desc', 'active');
            });

            const activeIcon = document.getElementById(`sort-icon-${activeField}`);
            if (activeIcon) {
                activeIcon.classList.add('active', direction);
            }
        }

        // Tri des transactions avec gestion des icônes
        function trierTransactions(field) {
            if (transactionSort.field === field) {
                transactionSort.direction = transactionSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                transactionSort.field = field;
                transactionSort.direction = 'asc';
            }

            updateTransactionSortIcons(field, transactionSort.direction);

            const container = document.getElementById('transactions-container');
            const items = Array.from(container.querySelectorAll('.transaction-item'));

            items.sort((a, b) => {
                let aValue, bValue;

                switch (field) {
                    case 'banque':
                        aValue = a.querySelector('.transaction-banque').textContent.trim();
                        bValue = b.querySelector('.transaction-banque').textContent.trim();
                        break;
                    case 'libelle':
                        aValue = a.querySelector('.transaction-libelle').textContent.trim();
                        bValue = b.querySelector('.transaction-libelle').textContent.trim();
                        break;
                    case 'montant':
                        aValue = parseFloat(a.querySelector('.transaction-montant').textContent.replace(/[€,\s]/g, '').replace(',', '.'));
                        bValue = parseFloat(b.querySelector('.transaction-montant').textContent.replace(/[€,\s]/g, '').replace(',', '.'));
                        break;
                }

                if (transactionSort.direction === 'asc') {
                    return aValue > bValue ? 1 : -1;
                } else {
                    return aValue < bValue ? 1 : -1;
                }
            });

            items.forEach(item => container.appendChild(item));
        }

        // Fonction pour mettre à jour les icônes de tri des transactions
        function updateTransactionSortIcons(activeField, direction) {
            const allIcons = document.querySelectorAll('.sort-icon-transaction');
            allIcons.forEach(icon => {
                icon.classList.remove('asc', 'desc', 'active');
            });

            const activeIcon = document.getElementById(`sort-icon-transaction-${activeField}`);
            if (activeIcon) {
                activeIcon.classList.add('active', direction);
            }
        }

// Fonction pour réappliquer le tri sans changer la direction
function applquerTriExistant() {
    if (!transactionSort.field) return;

    updateTransactionSortIcons(transactionSort.field, transactionSort.direction);

    const container = document.getElementById('transactions-container');
    const items = Array.from(container.querySelectorAll('.transaction-item'));

    if (items.length === 0) return;

    items.sort((a, b) => {
        let aValue, bValue;

        switch (transactionSort.field) {
            case 'banque':
                aValue = a.querySelector('.transaction-banque').textContent.trim();
                bValue = b.querySelector('.transaction-banque').textContent.trim();
                break;
            case 'libelle':
                aValue = a.querySelector('.transaction-libelle').textContent.trim();
                bValue = b.querySelector('.transaction-libelle').textContent.trim();
                break;
            case 'montant':
                aValue = parseFloat(a.querySelector('.transaction-montant').textContent.replace(/[€,\s]/g, '').replace(',', '.'));
                bValue = parseFloat(b.querySelector('.transaction-montant').textContent.replace(/[€,\s]/g, '').replace(',', '.'));
                break;
        }

        if (transactionSort.direction === 'asc') {
            return aValue > bValue ? 1 : -1;
        } else {
            return aValue < bValue ? 1 : -1;
        }
    });

    items.forEach(item => container.appendChild(item));
}

// Filtrage des comptes
function filtrerComptes() {
    const searchTerm = document.getElementById('compte-search').value.toLowerCase();
    const comptes = document.querySelectorAll('.compte-item');

    comptes.forEach(compte => {
        const numeroCompte = compte.dataset.compte.toLowerCase();
        const libelleCompte = compte.dataset.libelle.toLowerCase();

        let isVisible = false;

        // Si le terme de recherche est numérique, chercher UNIQUEMENT dans les numéros de compte
        if (/^\d+$/.test(searchTerm)) {
            isVisible = numeroCompte.startsWith(searchTerm);
        } else {
            // Si le terme contient des lettres, chercher dans les deux
            const numeroMatch = numeroCompte.startsWith(searchTerm);
            const libelleMatch = libelleCompte.includes(searchTerm);
            isVisible = numeroMatch || libelleMatch;
        }

        compte.style.display = isVisible ? 'grid' : 'none';
    });
}

function updateClearButton() {
    const searchInput = document.getElementById('compte-search');
    const clearButton = document.getElementById('compte-search-clear');

    if (searchInput.value.trim() !== '') {
        clearButton.style.display = 'flex';
    } else {
        clearButton.style.display = 'none';
    }
}

function clearCompteSearch() {
    const searchInput = document.getElementById('compte-search');
    const clearButton = document.getElementById('compte-search-clear');

    // Vider le champ
    searchInput.value = '';

    // Cacher le bouton
    clearButton.style.display = 'none';

    // Réafficher tous les comptes
    filtrerComptes();

    // Redonner le focus au champ de recherche
    searchInput.focus();

    // Effet visuel pour confirmer l'action
    clearButton.style.transform = 'translateY(-50%) scale(0.8)';
    setTimeout(() => {
        clearButton.style.transform = 'translateY(-50%) scale(1)';
    }, 150);
}

// Gestion de la sélection de texte avec surlignage automatique
        function handleTextSelection() {
            setTimeout(() => {
                const selection = window.getSelection();
                const selectedText = selection.toString().trim();

                console.log('🖱️ Sélection détectée:', selectedText); // DEBUG

                if (selectedText && selectedText.length > 2) {
                    const keywordInput1 = document.getElementById('search-keywords');
                    const keywordInput2 = document.getElementById('search-keywords-2');

                    console.log('✅ Sélection valide, champ 1 actuel:', keywordInput1.value); // DEBUG

                    // Si le premier champ est vide, remplir le premier
                    if (!keywordInput1.value.trim()) {
                        keywordInput1.value = selectedText;
                        console.log('📝 Remplissage champ 1'); // DEBUG
                    } else {
                        // Sinon, afficher et remplir le deuxième champ
                        console.log('📝 Remplissage champ 2'); // DEBUG
                        showSecondKeywordField();
                        keywordInput2.value = selectedText;
                    }

                    filtrerTransactions();
                }
            }, 100);
        }

        // Nouvelle fonction pour gérer l'apparition de la 2e barre
        function showSecondKeywordField() {
            const keywordInput2 = document.getElementById('search-keywords-2');
            keywordInput2.style.display = 'block';
        }

        // Gestionnaire pour la touche Entrée dans le premier champ
        function handleKeywordsKeydown(event) {
            if (event.key === 'Enter') {
                const keywordInput1 = document.getElementById('search-keywords');
                if (keywordInput1.value.trim()) {
                    showSecondKeywordField();
                }
            }
        }

        // Gestionnaire pour la perte de focus du premier champ
        function handleKeywordsBlur() {
            const keywordInput1 = document.getElementById('search-keywords');
            if (keywordInput1.value.trim()) {
                showSecondKeywordField();
            }
        }

// Fonction pour surligner les mots-clés dans toutes les transactions
function highlightKeywordsInAllTransactions(keywords1, keywords2) {
            const transactions = document.querySelectorAll('.transaction-libelle');

            transactions.forEach(transaction => {
                let originalText = transaction.getAttribute('data-original-text') || transaction.textContent;

                if (!transaction.getAttribute('data-original-text')) {
                    transaction.setAttribute('data-original-text', originalText);
                }

                let highlightedText = originalText;

// Surligner la première chaîne de mots-clés complète
if (keywords1 && keywords1.trim()) {
    const regex1 = new RegExp(`(${keywords1.trim().replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    highlightedText = highlightedText.replace(regex1, '<span class="keyword-highlight">$1</span>');
}

// Surligner la deuxième chaîne de mots-clés complète
if (keywords2 && keywords2.trim()) {
    const regex2 = new RegExp(`(${keywords2.trim().replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    highlightedText = highlightedText.replace(regex2, '<span class="keyword-highlight-2">$1</span>');
}

                transaction.innerHTML = highlightedText;
            });
        }

        // Gestion des comptes
        function selectionnerCompte(compte) {
            // Retirer la sélection précédente
            document.querySelectorAll('.compte-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Ajouter la sélection au nouveau compte
            const compteElement = document.querySelector(`[data-compte="${compte}"]`);
            if (compteElement) {
                compteElement.classList.add('selected');
            }

            compteSelectionne = compte;
            console.log('🏦 Compte sélectionné:', compte);

// Réinitialiser les filtres
document.getElementById('filter-banque').value = '';
document.getElementById('search-keywords').value = '';
document.getElementById('search-keywords-2').value = '';
document.getElementById('search-keywords-2').style.display = 'none';
document.getElementById('montant-operateur').value = '=';
document.getElementById('montant-valeur').value = '';

// Recharger les journaux avec l'état mis à jour
    chargerJournaux();

    // Filtrer et afficher les transactions
    filtrerTransactions();

// Conserver le tri actuel après changement de compte
if (transactionSort.field) {
    setTimeout(() => {
        applquerTriExistant();
    }, 50);
}

// Réinitialiser la sélection de groupe et charger les groupements
        groupeSelectionne = null;
        setTimeout(() => {
            console.log('🔄 Déclenchement chargement groupements pour compte:', compte);
            chargerGroupementsIntelligents();
        }, 200);

}

        // Gestion des filtres et intégration avec panneau droite
        function filtrerTransactions() {
            if (!compteSelectionne) {
                afficherEtatVideTransactions();
                return;
            }

            // Récupérer les valeurs des filtres
            const banque = document.getElementById('filter-banque').value;
            const montantOp = document.getElementById('montant-operateur').value;
            const montantVal = document.getElementById('montant-valeur').value;
            const montantVal2 = document.getElementById('montant-valeur2').value;
            const keywords1 = document.getElementById('search-keywords').value.trim();
            const keywords2 = document.getElementById('search-keywords-2').value.trim();
console.log('🔍 DEBUG - Début filtrerTransactions:', {
    compteSelectionne,
    chaine_complete_1: keywords1,
    chaine_complete_2: keywords2,
    nbEcrituresTotal: toutesEcritures.length
});

            // Gérer l'affichage du deuxième champ montant
            const montantVal2Input = document.getElementById('montant-valeur2');
            if (montantOp === 'entre') {
                montantVal2Input.style.display = 'block';
            } else {
                montantVal2Input.style.display = 'none';
            }

// Filtrer les écritures pour le compte sélectionné
let ecrituresCompte = toutesEcritures.filter(ecriture =>
    ecriture.compte_contrepartie === compteSelectionne
);

// Vérifier si on doit afficher les transactions couvertes
const showCoveredTransactions = document.getElementById('show-covered-transactions').checked;

console.log('🔍 État checkbox transactions couvertes:', showCoveredTransactions);
console.log('📊 Transactions avant filtrage couverture:', ecrituresCompte.length);

// Si on ne veut pas afficher les transactions couvertes, les filtrer
if (!showCoveredTransactions) {
    const ecrituresAvantFiltrage = ecrituresCompte.length;
    ecrituresCompte = ecrituresCompte.filter(ecriture => !ecriture.couverte_par_regle);
    console.log('📊 Transactions après filtrage couverture:', ecrituresCompte.length,
                `(${ecrituresAvantFiltrage - ecrituresCompte.length} transactions couvertes masquées)`);
}

// Appliquer les filtres
ecrituresFiltered = ecrituresCompte.filter(ecriture => {
                // Filtre banque
                if (banque && ecriture.journal_code !== banque) return false;

// Filtre mots-clés - Vérification des deux groupes (ET logique)
                const libelleMinuscule = ecriture.ecriture_lib.toLowerCase();

// Vérifier première chaîne complète
if (keywords1 && keywords1.trim()) {
    const chaine1 = keywords1.toLowerCase().trim();
    if (!libelleMinuscule.includes(chaine1)) return false;
}

// Vérifier deuxième chaîne complète
if (keywords2 && keywords2.trim()) {
    const chaine2 = keywords2.toLowerCase().trim();
    if (!libelleMinuscule.includes(chaine2)) return false;
}

// Filtre montant
if (montantOp && montantVal !== '') {
    const montant = ecriture.montant; // Suppression de Math.abs()
    const valeur = parseFloat(montantVal.replace(',', '.'));

    switch (montantOp) {
        case '<':
            if (montant >= valeur) return false;
            break;
        case '>':
            if (montant <= valeur) return false;
            break;
        case '<=':
            if (montant > valeur) return false;
            break;
        case '>=':
            if (montant < valeur) return false;
            break;
        case '!=':
            if (Math.abs(montant - valeur) <= 0.01) return false;
            break;
        case 'entre':
            const valeur2 = parseFloat(montantVal2.replace(',', '.'));
            if (!isNaN(valeur2)) {
                const min = Math.min(valeur, valeur2);
                const max = Math.max(valeur, valeur2);
                if (montant < min || montant > max) return false;
            }
            break;
case '=':
    if (montant !== valeur) return false;
    break;
        default:
            break;
    }
}

                return true;
            });

console.log('Filtrage par chaînes complètes:', {
    compteSelectionne,
    totalCompte: ecrituresCompte.length,
    filtrees: ecrituresFiltered.length,
    filtres: { 
        banque, 
        chaine_mots_cles_1: keywords1, 
        chaine_mots_cles_2: keywords2, 
        montantOp, 
        montantVal 
    }
});

// Afficher les transactions
afficherTransactions();

// Réappliquer le tri en cours après le filtrage
if (transactionSort.field) {
    setTimeout(() => {
        applquerTriExistant();
    }, 50);
}

// Mettre à jour les compteurs
mettreAJourCompteurs();

console.log('🔍 DEBUG - Écritures filtrées:', ecrituresFiltered.length);

// Surligner les mots-clés
highlightKeywordsInAllTransactions(keywords1, keywords2);

// Calculer l'impact potentiel
calculateImpactPotentiel(keywords1, keywords2);

// ✅ NOUVEAU : Désélectionner visuellement si plus de mots-clés
if (!keywords1 && !keywords2) {
    document.querySelectorAll('.group-item').forEach(item => item.classList.remove('selected'));
    groupeSelectionne = null;
}

// Recharger les groupements quand les filtres changent (mais pas quand un groupe est sélectionné)
if (compteSelectionne && groupeSelectionne === null) {
    setTimeout(() => {
        chargerGroupementsIntelligents();
    }, 100);
}

// Mettre à jour l'affichage du bouton "Créer une nouvelle règle"
toggleCreateRuleButton();

        }

// ========================================
// TRI INTELLIGENT UNIVERSEL - CHAÎNES COMMUNES FRÉQUENTES
// ========================================

function appliquerTriIntelligent(transactions) {
    if (!transactions || transactions.length === 0) return transactions;

    console.log('🧠 Tri intelligent universel - analyse des chaînes communes sur', transactions.length, 'transactions');

    // ÉTAPE 1 : Extraire les n-grams les plus fréquents des libellés originaux
    const ngramsFréquents = extraireNgramsFrequents(transactions);
    console.log('🔍 N-grams fréquents extraits:', ngramsFréquents.length);

    // Debug : afficher les top n-grams
    console.log('🏆 Top 10 n-grams les plus fréquents:');
    ngramsFréquents.slice(0, 10).forEach((ngram, i) => {
        console.log(`   ${i+1}. "${ngram.texte}" (${ngram.frequence} transactions, ${ngram.longueur} mots)`);
    });

    // ÉTAPE 2 : Associer chaque transaction au meilleur n-gram
    const transactionsAvecNgram = transactions.map(trans => ({
        ...trans,
        _meilleur_ngram: trouverMeilleurNgram(trans.ecriture_lib, ngramsFréquents),
        _signe_montant: determinerSigneMontant(trans.montant)
    }));

    // Debug : montrer quelques associations
    console.log('🔗 Échantillon d\'associations transaction → n-gram:');
    transactionsAvecNgram.slice(0, 6).forEach((t, i) => {
        console.log(`   ${i+1}. "${t.ecriture_lib.substring(0, 50)}..." → "${t._meilleur_ngram}"`);
    });

    // ÉTAPE 3 : Trier par n-gram (clé de regroupement) puis critères secondaires
    const transactionsTriees = transactionsAvecNgram.sort((a, b) => {
        // Critère 1: n-gram fréquent - SEULE CLÉ DE REGROUPEMENT
        if (a._meilleur_ngram !== b._meilleur_ngram) {
            return a._meilleur_ngram.localeCompare(b._meilleur_ngram);
        }

        // Critères secondaires pour ordre dans le même groupe
        // Critère 2: signe du montant
        if (a._signe_montant !== b._signe_montant) {
            return a._signe_montant.localeCompare(b._signe_montant);
        }

        // Critère 3: journal bancaire
        if (a.journal_code !== b.journal_code) {
            return a.journal_code.localeCompare(b.journal_code);
        }

        // Critère 4: libellé exact (stabilité)
        return a.ecriture_lib.localeCompare(b.ecriture_lib);
    });

    // ÉTAPE 4 : Statistiques de regroupement
    const ngramsUtilises = new Set(transactionsTriees.map(t => t._meilleur_ngram));
    const ratioCompression = ((1 - ngramsUtilises.size / transactions.length) * 100).toFixed(1);

    console.log('📊 Résultat du regroupement par n-grams:');
    console.log(`   • Transactions: ${transactions.length}`);
    console.log(`   • Groupes (n-grams uniques): ${ngramsUtilises.size}`);
    console.log(`   • Compression: ${ratioCompression}%`);

    // Debug : afficher la répartition des groupes
    const repartitionGroupes = {};
    transactionsTriees.forEach(t => {
        repartitionGroupes[t._meilleur_ngram] = (repartitionGroupes[t._meilleur_ngram] || 0) + 1;
    });

    const topGroupes = Object.entries(repartitionGroupes)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8);

    console.log('🎯 Top 8 groupes les plus importants:');
    topGroupes.forEach(([ngram, count]) => {
        console.log(`   • "${ngram}" (${count} transactions)`);
    });

    // Supprimer les champs temporaires
    return transactionsTriees.map(({_meilleur_ngram, _signe_montant, ...trans}) => trans);
}

// ========================================
// EXTRACTION DES N-GRAMS FRÉQUENTS
// ========================================

function extraireNgramsFrequents(transactions, seuilMinFrequence = 3, tailleMaxNgram = 5) {
    console.log('🔍 Extraction des n-grams fréquents...');

    // Compteur de n-grams
    const compteurNgrams = new Map();

    // Parcourir toutes les transactions
    transactions.forEach(trans => {
        const libelle = trans.ecriture_lib;
        if (!libelle) return;

        // Normaliser légèrement pour l'extraction (garder structure originale)
        const libelleNormalise = normaliserPourExtraction(libelle);

        // Extraire tous les n-grams de 2 à tailleMaxNgram mots
        for (let n = 2; n <= tailleMaxNgram; n++) {
            const ngramsDeN = extraireNgramsDeTailleN(libelleNormalise, n);

            ngramsDeN.forEach(ngram => {
                if (estNgramValide(ngram)) {
                    compteurNgrams.set(ngram, (compteurNgrams.get(ngram) || 0) + 1);
                }
            });
        }
    });

    // Filtrer par fréquence et trier
    const ngramsFrequents = Array.from(compteurNgrams.entries())
        .filter(([ngram, freq]) => freq >= seuilMinFrequence)
        .map(([ngram, freq]) => ({
            texte: ngram,
            frequence: freq,
            longueur: ngram.split(' ').length
        }))
        .sort((a, b) => {
            // Prioriser : 1) fréquence, 2) longueur, 3) alphabétique
            if (a.frequence !== b.frequence) {
                return b.frequence - a.frequence; // Plus fréquent d'abord
            }
            if (a.longueur !== b.longueur) {
                return b.longueur - a.longueur; // Plus long d'abord
            }
            return a.texte.localeCompare(b.texte); // Alphabétique
        });

    console.log(`   • N-grams extraits: ${compteurNgrams.size}`);
    console.log(`   • N-grams fréquents (≥${seuilMinFrequence}): ${ngramsFrequents.length}`);

    return ngramsFrequents;
}

// ========================================
// NORMALISATION LÉGÈRE POUR EXTRACTION
// ========================================

function normaliserPourExtraction(libelle) {
    // Normalisation légère qui préserve la structure pour la comparaison de chaînes complètes
    return libelle
        .toUpperCase()
        .replace(/[ÀÁÂÃÄÅ]/g, 'A')
        .replace(/[ÈÉÊË]/g, 'E')
        .replace(/[ÌÍÎÏ]/g, 'I')
        .replace(/[ÒÓÔÕÖ]/g, 'O')
        .replace(/[ÙÚÛÜ]/g, 'U')
        .replace(/Ç/g, 'C')
        .replace(/\s+/g, ' ')              // Espaces multiples seulement
        .trim();
}

// ========================================
// EXTRACTION DE N-GRAMS DE TAILLE N
// ========================================

function extraireNgramsDeTailleN(texte, n) {
    const mots = texte.split(' ').filter(mot => mot.length > 0);
    const ngrams = [];

    for (let i = 0; i <= mots.length - n; i++) {
        const ngram = mots.slice(i, i + n).join(' ');
        ngrams.push(ngram);
    }

    return ngrams;
}

// ========================================
// VALIDATION DES N-GRAMS
// ========================================

function estNgramValide(ngram) {
    // Mots à exclure des n-grams (trop génériques ou variables)
    const motsAExclure = new Set([
        // Dates et temps
        'JANVIER', 'FEVRIER', 'MARS', 'AVRIL', 'MAI', 'JUIN',
        'JUILLET', 'AOUT', 'SEPTEMBRE', 'OCTOBRE', 'NOVEMBRE', 'DECEMBRE',
        'JAN', 'FEV', 'MAR', 'AVR', 'JUN', 'JUL', 'AOU', 'SEP', 'OCT', 'NOV', 'DEC',
        'LUNDI', 'MARDI', 'MERCREDI', 'JEUDI', 'VENDREDI', 'SAMEDI', 'DIMANCHE',

        // Mots génériques bancaires
        'OPERATION', 'TRANSACTION', 'PAIEMENT', 'FACTURE', 'NUMERO', 'REFERENCE',

        // Mots très courts
        'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z',
        'LE', 'LA', 'LES', 'UN', 'UNE', 'DU', 'DE', 'DES', 'AU', 'AUX', 'ET', 'OU'
    ]);

    const mots = ngram.split(' ');

    // Rejeter si contient des mots à exclure
    if (mots.some(mot => motsAExclure.has(mot))) {
        return false;
    }

    // Rejeter si trop de chiffres (plus de 30% de chiffres)
    const nbCaracteres = ngram.replace(/\s/g, '').length;
    const nbChiffres = (ngram.match(/\d/g) || []).length;
    if (nbCaracteres > 0 && nbChiffres / nbCaracteres > 0.3) {
        return false;
    }

    // Rejeter si contient des séquences trop variables (dates)
    if (/\b\d{1,2}\/\d{1,2}\b/.test(ngram) || /\b\d{4,}\b/.test(ngram)) {
        return false;
    }

    // Rejeter si trop court au total
    if (ngram.length < 6) {
        return false;
    }

    return true;
}

// ========================================
// ASSOCIATION TRANSACTION → MEILLEUR N-GRAM
// ========================================

function trouverMeilleurNgram(libelle, ngramsFréquents) {
    if (!libelle) return 'AUTRE';

    const libelleNormalise = normaliserPourExtraction(libelle);

    // Chercher le n-gram le plus long et le plus fréquent qui matche
    for (const ngram of ngramsFréquents) {
        if (libelleNormalise.includes(ngram.texte)) {
            return ngram.texte;
        }
    }

    // Aucun n-gram fréquent trouvé → fallback
    return 'AUTRE';
}

// ========================================
// FONCTION UTILITAIRE
// ========================================

function determinerSigneMontant(montant) {
    const val = parseFloat(montant);
    if (val > 0.01) return 'A_POSITIF';
    if (val < -0.01) return 'B_NEGATIF';
    return 'C_ZERO';
}

// ========================================
// FONCTION DE TEST (À SUPPRIMER EN PRODUCTION)
// ========================================

function testerExtractionNgrams() {
    console.log('🧪 TEST EXTRACTION N-GRAMS');
    console.log('===========================');

    const exemples = [
        { ecriture_lib: 'CB PHARMACIE CENTRALE 14H30 248,00EUR' },
        { ecriture_lib: 'CB PHARMACIE CENTRALE 16H45 12,50EUR' },
        { ecriture_lib: 'CB BOULANGERIE PAUL 10H15 5,60EUR' },
        { ecriture_lib: 'VIR EMIS SALAIRE MARTIN JANVIER' },
        { ecriture_lib: 'VIR EMIS SALAIRE MARTIN FEVRIER' },
        { ecriture_lib: 'VIR EMIS SALAIRE DUPONT MARS' },
        { ecriture_lib: 'REMISE CB /01/03 R12345 COMMERCE' },
        { ecriture_lib: 'REMISE CB /15/03 R67890 COMMERCE' },
        { ecriture_lib: 'PRLV SEPA EDF FACT N°123' },
        { ecriture_lib: 'PRLV SEPA EDF FACT N°456' },
        { ecriture_lib: 'PRLV SEPA GAZ FACT N°789' }
    ];

    const ngrams = extraireNgramsFrequents(exemples, 2, 4);

    console.log('\n🔗 Test associations:');
    exemples.forEach((trans, i) => {
        const meilleurNgram = trouverMeilleurNgram(trans.ecriture_lib, ngrams);
        console.log(`${i+1}. "${trans.ecriture_lib}" → "${meilleurNgram}"`);
    });
}

// Décommenter pour tester en développement
// testerExtractionNgrams();

// Algorithme de clustering robuste avec fusion itérative
function construireClustersRobustes(transactions) {
    if (!transactions || transactions.length === 0) return [];

    console.log('🔗 Construction clusters robustes...');

    // 1. Initialiser : chaque transaction = 1 cluster
    let clusters = transactions.map((trans, index) => ({
        id: `cluster_${index}`,
        libelle_representatif: normaliserLibellePourCluster(trans.ecriture_lib),
        libelles_bruts: [trans.ecriture_lib],
        transactions: [trans],
        motifs_cles: extraireMotifsCles(trans.ecriture_lib)
    }));

    console.log('🎯 Clusters initiaux:', clusters.length);

    // 2. Fusion itérative basée sur la similarité
    let fusionsEffectuees = true;
    let iteration = 0;
    const maxIterations = 10; // Limite de sécurité

    while (fusionsEffectuees && iteration < maxIterations) {
        fusionsEffectuees = false;
        iteration++;

        console.log(`🔄 Itération fusion ${iteration}...`);

        // Comparer tous les pairs de clusters
        for (let i = 0; i < clusters.length - 1; i++) {
            for (let j = i + 1; j < clusters.length; j++) {
                const cluster1 = clusters[i];
                const cluster2 = clusters[j];

                // Calculer la similarité entre clusters
                const similarite = calculerSimilariteClusters(cluster1, cluster2);

                // Seuil de fusion adaptatif
                const seuilFusion = 0.75; // 75% de similarité minimum

                if (similarite >= seuilFusion) {
                    console.log(`🔗 Fusion clusters: "${cluster1.libelle_representatif}" + "${cluster2.libelle_representatif}" (similarité: ${(similarite * 100).toFixed(1)}%)`);

                    // Fusionner cluster2 dans cluster1
                    cluster1.libelles_bruts.push(...cluster2.libelles_bruts);
                    cluster1.transactions.push(...cluster2.transactions);
                    cluster1.motifs_cles = [...new Set([...cluster1.motifs_cles, ...cluster2.motifs_cles])];

                    // Recalculer le libellé représentatif
                    cluster1.libelle_representatif = calculerLibelleRepresentatif(cluster1.libelles_bruts);

                    // Supprimer cluster2
                    clusters.splice(j, 1);
                    fusionsEffectuees = true;
                    break;
                }
            }
            if (fusionsEffectuees) break; // Recommencer depuis le début après une fusion
        }

        console.log(`📊 Fin itération ${iteration}: ${clusters.length} clusters`);
    }

    // 3. Post-traitement : nommer les clusters de façon stable
    clusters = clusters.map((cluster, index) => ({
        ...cluster,
        id: `cluster_${String(index).padStart(3, '0')}_${cluster.libelle_representatif.substring(0, 20).replace(/\s+/g, '_').toLowerCase()}`
    }));

    console.log('✅ Clustering terminé:', {
        clusters_finaux: clusters.length,
        iterations: iteration,
        reduction: `${transactions.length} → ${clusters.length} (${((1 - clusters.length / transactions.length) * 100).toFixed(1)}% réduction)`
    });

    return clusters;
}

// Calculer la similarité entre deux clusters
function calculerSimilariteClusters(cluster1, cluster2) {
    // 1. Similarité des libellés représentatifs (poids 40%)
    const simLibelle = calculerSimilariteLibelles(cluster1.libelle_representatif, cluster2.libelle_representatif);

    // 2. Intersection des motifs clés (poids 40%)
    const motifs1 = new Set(cluster1.motifs_cles);
    const motifs2 = new Set(cluster2.motifs_cles);
    const intersection = new Set([...motifs1].filter(x => motifs2.has(x)));
    const union = new Set([...motifs1, ...motifs2]);
    const simMotifs = union.size > 0 ? intersection.size / union.size : 0;

    // 3. Similarité croisée des libellés bruts (poids 20%)
    let simCroisee = 0;
    let comparaisons = 0;

    for (const lib1 of cluster1.libelles_bruts.slice(0, 3)) { // Limiter pour performance
        for (const lib2 of cluster2.libelles_bruts.slice(0, 3)) {
            simCroisee += calculerSimilariteLibelles(lib1, lib2);
            comparaisons++;
        }
    }
    simCroisee = comparaisons > 0 ? simCroisee / comparaisons : 0;

    // Score composite pondéré
    const similariteComposite = (simLibelle * 0.4) + (simMotifs * 0.4) + (simCroisee * 0.2);

    return similariteComposite;
}

// Obtenir l'ID de cluster stable pour une transaction
function obtenirClusterStable(transaction, clusters) {
    const libelleNorm = normaliserLibellePourCluster(transaction.ecriture_lib);

    // Chercher le cluster qui contient cette transaction
    for (const cluster of clusters) {
        // Vérifier si la transaction fait partie de ce cluster
        const appartientAuCluster = cluster.transactions.some(t =>
            t.ecriture_lib === transaction.ecriture_lib &&
            t.journal_code === transaction.journal_code &&
            Math.abs(t.montant - transaction.montant) < 0.01
        );

        if (appartientAuCluster) {
            return cluster.id;
        }
    }

    // Fallback : chercher le cluster le plus similaire
    let meilleurCluster = clusters[0];
    let meilleureSimilarite = 0;

    for (const cluster of clusters) {
        const similarite = calculerSimilariteLibelles(libelleNorm, cluster.libelle_representatif);
        if (similarite > meilleureSimilarite) {
            meilleureSimilarite = similarite;
            meilleurCluster = cluster;
        }
    }

    return meilleurCluster ? meilleurCluster.id : 'cluster_000_autre';
}

// Calculer le libellé représentatif d'un cluster
function calculerLibelleRepresentatif(libelles) {
    if (!libelles || libelles.length === 0) return 'libelle_vide';
    if (libelles.length === 1) return normaliserLibellePourCluster(libelles[0]);

    // Trouver le libellé le plus "central" (qui a la similarité moyenne la plus élevée avec les autres)
    let meilleurLibelle = libelles[0];
    let meilleurScore = 0;

    for (const libelle of libelles) {
        let scoreTotal = 0;
        for (const autreLibelle of libelles) {
            if (libelle !== autreLibelle) {
                scoreTotal += calculerSimilariteLibelles(libelle, autreLibelle);
            }
        }
        const scoreMoyen = scoreTotal / (libelles.length - 1);

        if (scoreMoyen > meilleurScore) {
            meilleurScore = scoreMoyen;
            meilleurLibelle = libelle;
        }
    }

    return normaliserLibellePourCluster(meilleurLibelle);
}

// Normaliser un libellé pour le clustering
function normaliserLibellePourCluster(libelle) {
    if (!libelle) return 'libelle_vide';

    return libelle.toUpperCase()
        .replace(/[ÀÁÂÃÄÅ]/g, 'A')
        .replace(/[ÈÉÊË]/g, 'E')
        .replace(/[ÌÍÎÏ]/g, 'I')
        .replace(/[ÒÓÔÕÖ]/g, 'O')
        .replace(/[ÙÚÛÜ]/g, 'U')
        .replace(/Ç/g, 'C')
        .replace(/\b\d{2}\/\d{2}\/\d{4}\b/g, '') // dates complètes
        .replace(/\b\d{2}\/\d{2}\b/g, '')        // dates courtes
        .replace(/\b\d{4,}\b/g, '')             // numéros longs
        .replace(/[^\w\s]/g, ' ')               // ponctuation
        .replace(/\s+/g, ' ')                   // espaces multiples
        .trim();
}

// Extraire les motifs clés d'un libellé
function extraireMotifsCles(libelle) {
    const libelleNorm = normaliserLibellePourCluster(libelle);
    const mots = libelleNorm.split(' ').filter(mot => mot.length >= 3);

    const stopWords = new Set(['VIR', 'VIREMENT', 'PRLV', 'PRELEVEMENT', 'CARTE', 'FACTURE', 'PAIEMENT']);

    return mots.filter(mot => !stopWords.has(mot) && !/^\d+$/.test(mot));
}

function calculerSimilariteLibelles(libelle1, libelle2) {
    // Normaliser les libellés pour comparaison
    const norm1 = normaliserLibelle(libelle1);
    const norm2 = normaliserLibelle(libelle2);

    if (norm1 === norm2) return 1.0;

    // Diviser en mots
    const mots1 = norm1.split(' ').filter(mot => mot.length > 2);
    const mots2 = norm2.split(' ').filter(mot => mot.length > 2);

    if (mots1.length === 0 && mots2.length === 0) return 1.0;
    if (mots1.length === 0 || mots2.length === 0) return 0.0;

    // Calculer le coefficient de Jaccard sur les mots
    const set1 = new Set(mots1);
    const set2 = new Set(mots2);

    const intersection = new Set([...set1].filter(x => set2.has(x)));
    const union = new Set([...set1, ...set2]);

    const similariteBase = intersection.size / union.size;

    // Bonus si les premiers mots sont identiques (même entité principale)
    let bonusPremierMot = 0;
    if (mots1.length > 0 && mots2.length > 0 && mots1[0] === mots2[0]) {
        bonusPremierMot = 0.2;
    }

    // Bonus si même longueur approximative (variantes mineures)
    let bonusLongueur = 0;
    const ratioLongueur = Math.min(norm1.length, norm2.length) / Math.max(norm1.length, norm2.length);
    if (ratioLongueur > 0.8) {
        bonusLongueur = 0.1;
    }

    return Math.min(1.0, similariteBase + bonusPremierMot + bonusLongueur);
}

function extraireTopNgrams(transactions, topN = 10) {
    const ngramCounter = new Map();
    const stopWords = new Set(['de', 'du', 'des', 'le', 'la', 'les', 'un', 'une', 'et', 'ou', 'pour', 'par', 'sur', 'avec', 'sans', 'au', 'aux', 'carte', 'cb', 'vir', 'virement', 'paiement', 'retrait', 'facture', 'fact', 'fac', 'operation', 'oper', 'transaction', 'trans', 'prelevement', 'prlv', 'echeance', 'ech']);

    transactions.forEach(trans => {
        const libelle = normaliserLibelle(trans.ecriture_lib);
        const ngrams = extraireNgrams(libelle, stopWords);

        ngrams.forEach(ngram => {
            ngramCounter.set(ngram, (ngramCounter.get(ngram) || 0) + 1);
        });
    });

    // Garder les n-grams avec au moins 2 occurrences et trier par fréquence puis longueur
    const ngramsFrequents = Array.from(ngramCounter.entries())
        .filter(([ngram, count]) => count >= 2)
        .sort(([a, countA], [b, countB]) => {
            if (countA !== countB) return countB - countA; // Plus fréquent d'abord
            return b.length - a.length; // Plus long d'abord si même fréquence
        })
        .slice(0, topN)
        .map(([ngram]) => ngram);

    return ngramsFrequents;
}

function normaliserLibelle(libelle) {
    if (!libelle) return "";

    // Majuscules et suppression des accents
    let normalise = libelle.toUpperCase()
        .replace(/[ÀÁÂÃÄÅ]/g, 'A')
        .replace(/[ÈÉÊË]/g, 'E')
        .replace(/[ÌÍÎÏ]/g, 'I')
        .replace(/[ÒÓÔÕÖ]/g, 'O')
        .replace(/[ÙÚÛÜ]/g, 'U')
        .replace(/Ç/g, 'C')
        .replace(/Ñ/g, 'N');

    // Supprimer les éléments variables
    normalise = normalise
        .replace(/\b\d{2}\/\d{2}\/\d{4}\b/g, '') // dates complètes
        .replace(/\b\d{2}\/\d{2}\b/g, '')        // dates courtes
        .replace(/\b\d{4,}\b/g, '');             // numéros longs

    return normalise.trim();
}

function extraireNgrams(libelle, stopWords, maxLength = 4) {
    const mots = libelle.split(/\s+/).filter(mot => mot.length > 0);
    const ngrams = [];

    for (let n = 2; n <= Math.min(mots.length, maxLength); n++) {
        for (let i = 0; i <= mots.length - n; i++) {
            const ngramMots = mots.slice(i, i + n);

            // Filtrer les n-grams trop génériques ou courts
            if (ngramMots.some(mot => stopWords.has(mot.toLowerCase()) || mot.length < 3 || /^\d+$/.test(mot))) {
                continue;
            }

            // NOUVEAU : Filtrer les n-grams trop riches en chiffres (bruit)
            const ngram = ngramMots.join(' ');
            const pourcentageChiffres = calculerPourcentageChiffres(ngram);
            if (pourcentageChiffres > 40) { // Plus de 40% de chiffres = bruit
                continue;
            }

            ngrams.push(ngram);
        }
    }

    return ngrams;
}

function calculerPourcentageChiffres(texte) {
    const totalCaracteres = texte.replace(/\s/g, '').length; // Sans espaces
    const chiffres = texte.match(/\d/g) || [];
    return totalCaracteres > 0 ? (chiffres.length / totalCaracteres) * 100 : 0;
}

function determinerClefNgram(transaction, topNgrams) {
    const libelle = normaliserLibelle(transaction.ecriture_lib);

    // Chercher le premier n-gram présent dans le libellé
    for (const ngram of topNgrams) {
        if (libelle.includes(ngram)) {
            return ngram;
        }
    }

    // NOUVEAU : Fallback sur motif plus large pour éviter la fragmentation
    // Si aucun n-gram spécifique trouvé, essayer de regrouper par motifs plus larges
    const motifLarge = determinerMotifLarge(libelle);
    if (motifLarge !== "autre") {
        return motifLarge;
    }

    // Aucun motif trouvé -> clef neutre (triée en bas)
    return "zzzz_autre";
}

function determinerMotifLarge(libelle) {
    // Motifs de regroupement large pour éviter la fragmentation

    // 1. Virements (VIR, VIREMENT)
    if (/\b(VIR|VIREMENT)\b/.test(libelle)) {
        return "a_virements";
    }

    // 2. Prélèvements (PRLV, PRELEVEMENT)
    if (/\b(PRLV|PRELEVEMENT)\b/.test(libelle)) {
        return "b_prelevements";
    }

    // 3. Cartes bancaires (CB, CARTE)
    if (/\b(CB|CARTE)\b/.test(libelle)) {
        return "c_cartes";
    }

    // 4. Chèques (CHQ, CHEQUE)
    if (/\b(CHQ|CHEQUE)\b/.test(libelle)) {
        return "d_cheques";
    }

    // 5. Factures (FACT, FACTURE, FAC)
    if (/\b(FACT|FACTURE|FAC)\b/.test(libelle)) {
        return "e_factures";
    }

    // 6. Salaires (SALAIRE, SAL, PAIE)
    if (/\b(SALAIRE|SAL|PAIE)\b/.test(libelle)) {
        return "f_salaires";
    }

    // 7. Remboursements (REMB, REMBOURSEMENT)
    if (/\b(REMB|REMBOURSEMENT)\b/.test(libelle)) {
        return "g_remboursements";
    }

    // 8. Frais bancaires (FRAIS, COMMISSION, AGIOS)
    if (/\b(FRAIS|COMMISSION|AGIOS)\b/.test(libelle)) {
        return "h_frais_bancaires";
    }

    // 9. Cotisations sociales (URSSAF, MSA, CPAM)
    if (/\b(URSSAF|MSA|CPAM|COTISATION)\b/.test(libelle)) {
        return "i_cotisations";
    }

    // 10. Impôts et taxes (IMPOT, TAXE, TRESOR, DGI)
    if (/\b(IMPOT|TAXE|TRESOR|DGI)\b/.test(libelle)) {
        return "j_impots_taxes";
    }

    // 11. Fournisseurs avec noms propres (mots de 3+ lettres consécutifs)
    const motsLongs = libelle.match(/\b[A-Z]{3,}\b/g);
    if (motsLongs && motsLongs.length >= 2) {
        // Regrouper par première lettre du premier mot long
        return `k_fournisseur_${motsLongs[0].charAt(0).toLowerCase()}`;
    }

    // 12. Transactions avec montants récurrents (même journal + montant similaire)
    // Note: Ceci nécessiterait une analyse plus complexe dans un vrai contexte

    return "autre";
}

function determinerSigneMontant(montant) {
    const val = parseFloat(montant);
    if (val > 0) return "A_positif";
    if (val < 0) return "B_negatif";
    return "C_zero";
}

function afficherTransactions() {
    const container = document.getElementById('transactions-container');
    const emptyState = document.getElementById('transactions-empty');

    if (ecrituresFiltered.length === 0) {
        if (!compteSelectionne) {
            container.innerHTML = `
                <div class="empty-state">
                    <div>💳</div>
                    <p>Sélectionnez un compte pour voir les transactions</p>
                </div>
            `;
        } else {
            container.innerHTML = `
                <div class="empty-state">
                    <div>🔍</div>
                    <p>Aucune transaction ne correspond aux critères</p>
                    <small>Modifiez les filtres pour voir plus de résultats</small>
                </div>
            `;
        }
        return;
    }

// NOUVEAU : Appliquer le tri intelligent par défaut si aucun tri manuel n'est actif
let ecrituresATrierEtAfficher = [...ecrituresFiltered];
if (!transactionSort.field) {
    ecrituresATrierEtAfficher = appliquerTriIntelligent(ecrituresATrierEtAfficher);
}

// Appliquer la pagination
let ecrituresAffichees = ecrituresATrierEtAfficher;
if (paginationLimit !== null && paginationLimit > 0) {
    ecrituresAffichees = ecrituresATrierEtAfficher.slice(0, paginationLimit);
}

let html = '';
ecrituresAffichees.forEach(ecriture => {
                const montantClass = ecriture.montant >= 0 ? 'montant-positif' : 'montant-negatif';
                const montantFormate = Math.abs(ecriture.montant).toFixed(2).replace('.', ',');
                const signe = ecriture.montant >= 0 ? '' : '-';

                // Trouver le journal correspondant pour le tooltip
                const journal = journaux.find(j => j.journal_code === ecriture.journal_code);
                const journalLibelle = journal ? journal.journal_lib : ecriture.journal_code;

html += `
    <div class="transaction-item fade-in">
        <div class="transaction-banque"
             onmouseenter="showBanqueTooltip(this, '${journalLibelle}')"
             onmouseleave="hideBanqueTooltip(this)">
            ${ecriture.journal_code}
            <div class="tooltip-custom tooltip-banque">${journalLibelle}</div>
        </div>
        <div class="transaction-libelle" onmouseup="handleTextSelection()">
            ${ecriture.ecriture_lib}
        </div>
<div class="transaction-montant ${montantClass}">
            ${signe}${montantFormate}
        </div>
    </div>
`;
            });

            container.innerHTML = html;
        }

        function afficherEtatVideTransactions() {
            const container = document.getElementById('transactions-container');
            container.innerHTML = `
                <div class="empty-state">
                    <div>💳</div>
                    <p>Sélectionnez un compte pour voir les transactions</p>
                </div>
            `;
        }

function mettreAJourCompteurs() {
    const countDisplay = document.getElementById('transactions-count-display');
    const count = ecrituresFiltered.length;

// Calculer l'impact local pour l'affichage
    const keywords1 = document.getElementById('search-keywords').value;
    const keywords2 = document.getElementById('search-keywords-2').value;
    let impactLocalText = '';

    if (((keywords1 && keywords1.trim() !== '') || (keywords2 && keywords2.trim() !== '')) && compteSelectionne) {
        const ecrituresCompte = toutesEcritures.filter(e => e.compte_contrepartie === compteSelectionne);
        const totalCompte = ecrituresCompte.length;
        const impactLocal = totalCompte > 0 ? (count / totalCompte * 100) : 0;
        impactLocalText = ` • ${Math.round(impactLocal)}% du compte`;
    }

    countDisplay.textContent = `${count} transaction${count > 1 ? 's' : ''}${impactLocalText}`;
}

function calculateImpactPotentiel(keywords1, keywords2) {
    const collisionElement = document.getElementById('collision-percentage');
    const collisionInfo = document.getElementById('collision-info');

    if ((!keywords1 || keywords1.trim() === '') && (!keywords2 || keywords2.trim() === '') || !compteSelectionne) {
        updateCreateRuleButton(0); // Remplacer impactElement.textContent = '0%';
        collisionInfo.classList.add('hidden');
        return;
    }

    // Récupérer TOUS les filtres actifs
    const banque = document.getElementById('filter-banque').value;
    const montantOp = document.getElementById('montant-operateur').value;
    const montantVal = document.getElementById('montant-valeur').value;
    const montantVal2 = document.getElementById('montant-valeur2').value;

// Préparer les chaînes de mots-clés complètes
const chaine1 = keywords1 ? keywords1.toLowerCase().trim() : '';
const chaine2 = keywords2 ? keywords2.toLowerCase().trim() : '';

function updateCreateRuleButton(impactPercent, collisionPercent = 0) {
    const btnProgress = document.getElementById('btn-progress-bar');
    const btn = document.getElementById('create-rule-btn');
    
    if (!btnProgress || !btn) return;

    // 1. Supprimer toutes les classes d'état ET réinitialiser tous les styles
    btn.classList.remove('btn-neutral', 'btn-low-impact', 'btn-high-impact', 'btn-excellent', 'btn-aura');
    btn.style.background = '';
    btn.style.color = '';
    btn.style.boxShadow = '';

    // 2. Gestion de l'affichage conditionnel
    if (impactPercent === 0) {
        btn.classList.add('btn-neutral');
        btnProgress.style.display = 'none';
        btnProgress.style.width = '0%';
        return;
    }
// 3. Impact > 0 : afficher la barre de progression (sauf à 100%)
if (impactPercent >= 100) {
    btnProgress.style.display = 'none';
    btnProgress.style.width = '0%';
    btnProgress.style.height = '0px';
    btnProgress.style.background = '';
    btnProgress.style.boxShadow = '';
} else {
    btnProgress.style.display = 'block';
    btnProgress.style.width = `${Math.min(impactPercent, 100)}%`;
}

    // 4. Couleurs avec progressivité turquoise MOINS saturée
    if (impactPercent < 30) {
        // 1-29% : turquoise très pâle
        const lightness = 220 - (impactPercent * 2); // 220 → 160
        btn.style.background = `rgb(${lightness}, ${lightness + 10}, ${lightness + 15})`;
        btn.style.color = '#1d1d1f';
        
    } else if (impactPercent < 70) {
        // 30-69% : turquoise modéré
        const greenBlue = Math.floor(180 + (impactPercent - 30) * 1.8); // 180 → 252
        btn.style.background = `rgb(0, ${greenBlue}, ${greenBlue})`;
        btn.style.color = 'white';
        
    } else if (impactPercent < 90) {
        // 70-89% : turquoise standard
        btn.style.background = '#00d4d4';
        btn.style.color = 'white';
        btn.style.boxShadow = '0 2px 8px rgba(0, 212, 212, 0.2)';
        
    } else {
        // 90%+ : turquoise légèrement saturé SANS dégradé (homogène)
        btn.classList.add('btn-excellent');
        
        // Saturation beaucoup plus modérée
        const maxSaturation = 220; // Réduit de 230 à 220
        const saturationProgress = Math.min((impactPercent - 90) / 10, 1); // 0 à 1 sur 90%-100%
        const saturation = 212 + Math.floor(saturationProgress * (maxSaturation - 212)); // 212 → 220
        
        // Couleur HOMOGÈNE sans dégradé
        btn.style.background = `rgb(0, ${saturation}, ${saturation})`;
        btn.style.color = 'white';
        btn.style.boxShadow = `0 2px 8px rgba(0, ${saturation}, ${saturation}, 0.3)`;
        
        // Aura uniquement si aucune collision
        if (collisionPercent === 0) {
            btn.classList.add('btn-aura');
            btn.style.boxShadow = `0 2px 8px rgba(0, ${saturation}, ${saturation}, 0.3), 0 0 20px rgba(0, ${saturation}, ${saturation}, 0.25)`;
        }
    }
    
    // Couleur de la barre harmonisée avec le bouton
    if (impactPercent < 30) {
        // Barre grise pour faible impact
        btnProgress.style.background = 'linear-gradient(90deg, #d1d1d6 0%, #c7c7cc 100%)';
        btnProgress.style.boxShadow = 'inset 0 1px 2px rgba(0,0,0,0.1)';
        
    } else if (impactPercent < 70) {
        // Barre turquoise modérée
        const barGreenBlue = Math.floor(150 + (impactPercent - 30) * 2.5);
        btnProgress.style.background = `linear-gradient(90deg, rgb(0, ${barGreenBlue}, ${barGreenBlue}) 0%, rgb(0, ${Math.max(barGreenBlue - 20, 130)}, ${Math.max(barGreenBlue - 20, 130)}) 100%)`;
        btnProgress.style.boxShadow = `inset 0 1px 2px rgba(0,0,0,0.1), 0 0 8px rgba(0,${barGreenBlue},${barGreenBlue},0.3)`;
        
    } else if (impactPercent < 90) {
        // Barre turquoise standard
        btnProgress.style.background = 'linear-gradient(90deg, #00d4d4 0%, #00baba 100%)';
        btnProgress.style.boxShadow = 'inset 0 1px 2px rgba(0,0,0,0.1), 0 0 8px rgba(0,212,212,0.3)';
        
    } else {
        // Barre saturée pour 90%+ avec modération
        const maxBarSaturation = 220; // Même limite que le bouton
        const barSaturationProgress = Math.min((impactPercent - 90) / 10, 1);
        const barSaturation = 212 + Math.floor(barSaturationProgress * (maxBarSaturation - 212));
        
        if (impactPercent >= 95) {
            btnProgress.style.background = `linear-gradient(90deg, rgb(0, ${Math.min(barSaturation + 8, maxBarSaturation)}, ${Math.min(barSaturation + 8, maxBarSaturation)}) 0%, rgb(0, ${barSaturation}, ${barSaturation}) 50%, rgb(0, ${Math.min(barSaturation + 4, maxBarSaturation)}, ${Math.min(barSaturation + 4, maxBarSaturation)}) 100%)`;
            btnProgress.style.boxShadow = `inset 0 1px 2px rgba(0,0,0,0.1), 0 0 12px rgba(0,${barSaturation},${barSaturation},0.4)`;
        } else {
            btnProgress.style.background = `linear-gradient(90deg, rgb(0, ${Math.min(barSaturation + 4, maxBarSaturation)}, ${Math.min(barSaturation + 4, maxBarSaturation)}) 0%, rgb(0, ${barSaturation}, ${barSaturation}) 100%)`;
            btnProgress.style.boxShadow = `inset 0 1px 2px rgba(0,0,0,0.1), 0 0 10px rgba(0,${barSaturation},${barSaturation},0.3)`;
        }
    }
}

// Fonction pour vérifier si une écriture matche TOUS les critères
    function ecritureMatchTousCriteres(ecriture) {
// 1. Vérifier les mots-clés - correspondance des deux groupes
        const libelleMinuscule = ecriture.ecriture_lib.toLowerCase();

// Vérifier première chaîne complète
if (keywords1 && keywords1.trim()) {
    const chaine1 = keywords1.toLowerCase().trim();
    if (!libelleMinuscule.includes(chaine1)) return false;
}

// Vérifier deuxième chaîne complète
if (keywords2 && keywords2.trim()) {
    const chaine2 = keywords2.toLowerCase().trim();
    if (!libelleMinuscule.includes(chaine2)) return false;
}

        // 2. Vérifier la banque
        if (banque && ecriture.journal_code !== banque) return false;

        // 3. Vérifier le montant
        if (montantOp && montantVal !== '') {
            const montant = ecriture.montant;
            const valeur = parseFloat(montantVal.replace(',', '.'));

            switch (montantOp) {
                case '<':
                    if (montant >= valeur) return false;
                    break;
                case '>':
                    if (montant <= valeur) return false;
                    break;
                case '<=':
                    if (montant > valeur) return false;
                    break;
                case '>=':
                    if (montant < valeur) return false;
                    break;
                case '!=':
                    if (Math.abs(montant - valeur) <= 0.01) return false;
                    break;
case '=':
    if (montant !== valeur) return false;
    break;
                case 'entre':
                    const valeur2 = parseFloat(montantVal2.replace(',', '.'));
                    if (!isNaN(valeur2)) {
                        const min = Math.min(valeur, valeur2);
                        const max = Math.max(valeur, valeur2);
                        if (montant < min || montant > max) return false;
                    }
                    break;
            }
        }

        return true;
    }

// 1. Calculer l'impact local (matches dans le compte sélectionné)
const ecrituresCompte = toutesEcritures.filter(e => e.compte_contrepartie === compteSelectionne);
const matchesCompte = ecrituresCompte.filter(ecritureMatchTousCriteres);

const totalCompte = ecrituresCompte.length;
const nbMatchesCompte = matchesCompte.length;
// Stocker nbMatchesCompte dans une variable globale pour le modal
window.nbMatchesCompte = nbMatchesCompte;
const impactLocal = totalCompte > 0 ? (nbMatchesCompte / totalCompte * 100) : 0;

// 2. Calculer l'impact global (matches sur TOUTES les transactions)
const matchesGlobal = toutesEcritures.filter(ecritureMatchTousCriteres);
const nbMatchesGlobal = matchesGlobal.length;
const totalGlobal = toutesEcritures.length;
const impactGlobal = totalGlobal > 0 ? (nbMatchesGlobal / totalGlobal * 100) : 0;

    // 2. Calculer les collisions (matches dans les AUTRES comptes avec les MÊMES critères)
    const ecrituresAutres = toutesEcritures.filter(e => e.compte_contrepartie !== compteSelectionne);
    const matchesAutres = ecrituresAutres.filter(ecritureMatchTousCriteres);

    const nbMatchesAutres = matchesAutres.length;

    // 3. Calcul du % de collision selon votre formule
    const collision = nbMatchesCompte > 0 ? (nbMatchesAutres / nbMatchesCompte * 100) : 0;

// 4. Mettre à jour l'affichage (impact local dans le bouton)
updateCreateRuleButton(impactLocal, collision);

// 5. Afficher ou cacher la collision
if (nbMatchesAutres > 0) {
    collisionElement.textContent = `${nbMatchesAutres} transaction${nbMatchesAutres > 1 ? 's' : ''}`;
    collisionInfo.classList.remove('hidden');
} else {
    collisionInfo.classList.add('hidden');
}

// Stocker les détails des collisions pour le modal
collisionDetails = [];
if (nbMatchesAutres > 0) {
    const collisionsByCompte = {};
    matchesAutres.forEach(e => {
        const compte = e.compte_contrepartie;
        if (!collisionsByCompte[compte]) {
            collisionsByCompte[compte] = { transactions: [] };
        }
        collisionsByCompte[compte].transactions.push(e);
    });

    // Convertir en format pour le modal et trier par nombre de transactions décroissant
    Object.keys(collisionsByCompte)
        .map(compte => ({
            compte: compte,
            libelle: getLibelleCompte(compte),
            transactions: collisionsByCompte[compte].transactions
        }))
        .sort((a, b) => b.transactions.length - a.transactions.length)
        .forEach(compteDetail => {
            collisionDetails.push(compteDetail);
        });
}

    // DEBUG amélioré
    console.log('=== CALCUL IMPACT & COLLISION (TOUS FILTRES) ===');
console.log('Filtres actifs:', {
    chaine_mots_cles_1: chaine1,
    chaine_mots_cles_2: chaine2,
    banque: banque || 'Toutes',
    montant: montantOp && montantVal ? `${montantOp} ${montantVal}` : 'Tous'
});
    console.log('Compte sélectionné:', compteSelectionne);
console.log('Matches dans le compte:', nbMatchesCompte, '/', totalCompte);
    console.log('Impact:', impactLocal.toFixed(1) + '%');
    console.log('Matches autres comptes:', nbMatchesAutres);
    console.log('Collision:', collision.toFixed(1) + '%');
console.log('Détails collisions stockés:', collisionDetails);
}

function changePagination() {
    const value = document.getElementById('pagination-select').value;
    console.log('📄 Pagination changée:', value);

    // Stocker la nouvelle limite
    paginationLimit = value === 'all' ? null : parseInt(value);

    // Ré-afficher les transactions avec la nouvelle limite
    afficherTransactions();

    // Réappliquer le tri en cours après le changement de pagination
    if (transactionSort.field) {
        setTimeout(() => {
            applquerTriExistant();
        }, 50);
    }
}

function viderFiltres() {
    document.getElementById('filter-banque').value = '';
    document.getElementById('montant-operateur').value = '=';
    document.getElementById('montant-valeur').value = '';
    document.getElementById('search-keywords').value = '';
    document.getElementById('montant-valeur2').style.display = 'none';

    // Restaurer le texte original des transactions
    const transactions = document.querySelectorAll('.transaction-libelle');
    transactions.forEach(transaction => {
        const originalText = transaction.getAttribute('data-original-text');
        if (originalText) {
            transaction.innerHTML = originalText;
        }
    });

    filtrerTransactions();

    // Réappliquer le tri en cours après le filtrage
    if (transactionSort.field) {
        setTimeout(() => {
            applquerTriExistant();
        }, 50);
    }
}

        // Gestion dropdown paramètres
        function toggleSettings() {
            const dropdown = document.getElementById('settingsDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

// Fermer dropdown en cliquant ailleurs
document.addEventListener('click', function(e) {
    if (!e.target.closest('.settings-dropdown')) {
        const settingsDropdown = document.getElementById('settingsDropdown');
        if (settingsDropdown) {
            settingsDropdown.style.display = 'none';
        }
    }

    // Fermer le dropdown société si on clique ailleurs
    if (!e.target.closest('.company-section') && !e.target.closest('.apple-intelligence-dropdown')) {
        const companyDropdown = document.getElementById('companyDropdown');
        if (companyDropdown && companyDropdown.style.display === 'block') {
            companyDropdown.style.display = 'none';
            const dropdownIndicator = document.querySelector('.dropdown-indicator');
            if (dropdownIndicator) {
                dropdownIndicator.style.transform = 'rotate(0deg)';
            }
        }
    }
});

// Navigation par flèches haut/bas pour changer de compte + Ctrl+Entrée pour créer une règle + Retour arrière pour vider recherche
        document.addEventListener('keydown', function(e) {
// Raccourci pour vider la recherche avec Retour arrière (quand aucun champ n'est focalisé)
            if ((e.key === 'Backspace' || e.key === 'Delete') &&
                !e.target.matches('input, textarea, select') &&
                !window.getSelection().toString()) {

                const keywordInput1 = document.getElementById('search-keywords');
                const keywordInput2 = document.getElementById('search-keywords-2');

                // Si les deux champs sont remplis, vider d'abord le deuxième
                if (keywordInput1.value.trim() !== '' && keywordInput2.value.trim() !== '') {
                    e.preventDefault();
                    console.log('🧹 Vidage du champ de recherche 2 avec', e.key);
                    keywordInput2.value = '';
                    filtrerTransactions();

// Effet visuel supprimé
                }
                // Sinon, vider le premier champ et cacher le deuxième
                else if (keywordInput1.value.trim() !== '') {
                    e.preventDefault();
                    console.log('🧹 Vidage du champ de recherche 1 avec', e.key);
                    keywordInput1.value = '';
                    keywordInput2.style.display = 'none';
                    keywordInput2.value = '';
                    filtrerTransactions();

// Effet visuel supprimé
                }
                return;
            }

// Raccourci Ctrl+Entrée pour créer une nouvelle règle
if (e.ctrlKey && e.key === 'Enter') {
    e.preventDefault();
    console.log('⚡ Raccourci Ctrl+Entrée détecté - Création de règle');

    // Simuler un clic sur le bouton "Créer une nouvelle règle"
    const boutonCreerRegle = document.querySelector('.create-rule-btn-liquid');
    if (boutonCreerRegle) {
        // Effet visuel pour montrer que le raccourci fonctionne
        boutonCreerRegle.style.transform = 'scale(0.95)';
        setTimeout(() => {
            boutonCreerRegle.style.transform = '';
        }, 100);

        // Déclencher la fonction
        creerNouvelleRegle();
    } else {
        console.warn('⚠️ Bouton "Créer une nouvelle règle" non trouvé');
    }
    return;
}

            // Vérifier que nous avons un compte sélectionné et des comptes visibles pour la navigation
            if (!compteSelectionne || document.querySelectorAll('.compte-item[style="display: grid;"], .compte-item:not([style*="display: none"])').length === 0) {
                return;
            }

            if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                e.preventDefault(); // Empêcher le scroll de la page

                // Récupérer tous les comptes visibles (non filtrés)
                const comptesVisibles = Array.from(document.querySelectorAll('.compte-item'))
                    .filter(compte => compte.style.display !== 'none');

                if (comptesVisibles.length === 0) return;

                // Trouver l'index du compte actuellement sélectionné
                const compteActuelIndex = comptesVisibles.findIndex(compte =>
                    compte.dataset.compte === compteSelectionne
                );

let nouveauIndex;

                if (e.key === 'ArrowDown') {
                    // Flèche bas : compte suivant (s'arrêter au dernier)
                    nouveauIndex = Math.min(compteActuelIndex + 1, comptesVisibles.length - 1);
                } else {
                    // Flèche haut : compte précédent (s'arrêter au premier)
                    nouveauIndex = Math.max(compteActuelIndex - 1, 0);
                }

                // Ne rien faire si on est déjà au bout et qu'on essaie d'aller plus loin
                if (nouveauIndex === compteActuelIndex) {
                    console.log('🚫 Fin de liste atteinte:', e.key === 'ArrowDown' ? 'bas' : 'haut');
                    return;
                }

                // Sélectionner le nouveau compte
                const nouveauCompte = comptesVisibles[nouveauIndex].dataset.compte;
                selectionnerCompte(nouveauCompte);

                // Faire défiler pour s'assurer que le compte sélectionné est visible
                comptesVisibles[nouveauIndex].scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });

                console.log('🎯 Navigation clavier:', {
                    direction: e.key === 'ArrowDown' ? 'bas' : 'haut',
                    ancien: compteSelectionne,
                    nouveau: nouveauCompte,
                    index: `${compteActuelIndex} → ${nouveauIndex}`
                });
            }
        });

        // Actions des boutons
        function nouveauFEC() {
            document.getElementById('uploadModal').style.display = 'block';
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
            resetUploadModal();
        }

        function importerRegles() {
            alert('Import des règles - À implémenter');
        }

        function exporterRegles() {
            alert('Export des règles - À implémenter');
        }

        function voirListeRegles() {
            window.location.href = '/regles/liste';
        }

function creerNouvelleRegle() {
    if (!compteSelectionne) {
        afficherNotification('warning', 'Sélectionnez d\'abord un compte pour créer une règle');
        return;
    }

    // Vérifier qu'on a au moins une chaîne de mots-clés
    const keywords = document.getElementById('search-keywords').value.trim();
    if (!keywords) {
        afficherNotification('warning', 'Saisissez au moins une chaîne de mots-clés pour créer une règle');
        return;
    }

    // Récupérer l'ID du FEC actuel de façon sécurisée
    let fecId = null;
    try {
        const fecData = {{ fec_actif.id if fec_actif else 'null' }};
        fecId = (fecData && fecData !== 'null') ? fecData : null;
    } catch (error) {
        console.error('🚨 ERREUR récupération FEC ID:', error);
        fecId = null;
    }

    // Vérifier que nous avons un FEC actif
    if (!fecId) {
        afficherNotification('error', 'Aucun fichier FEC actif trouvé. Importez d\'abord un FEC.');
        return;
    }

    // Construire les données de la règle
    const keywords2 = document.getElementById('search-keywords-2').value.trim();
    const montantOp = document.getElementById('montant-operateur').value;
    const montantVal = document.getElementById('montant-valeur').value;
    const montantVal2 = document.getElementById('montant-valeur2').value;
    
    const regleData = {
        nom: `Règle ${compteSelectionne} - ${keywords.substring(0, 20)}`,
        mot_cle_1: keywords,
        mot_cle_2: keywords2 || null,
        compte_destination: compteSelectionne,
        libelle_destination: getLibelleCompte(compteSelectionne),
        journal_code: document.getElementById('filter-banque').value || null,
        fec_id: fecId,
        societe_id: societeId
    };

    // Ajouter les critères de montant si définis
    if (montantOp && montantOp !== '=' && montantVal) {
        regleData.criteres_montant = {
            operateur: montantOp,
            valeur: parseFloat(montantVal.replace(',', '.')),
            valeur2: montantOp === 'entre' && montantVal2 ? parseFloat(montantVal2.replace(',', '.')) : null
        };
    }

    console.log('🔍 Données de la règle à créer:', regleData);

    // Créer la règle via AJAX
    fetch('/regles/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(regleData)
    })
    .then(response => {
        console.log('📡 Réponse serveur status:', response.status);
        
        if (!response.ok) {
            throw new Error(`Erreur HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response.json();
    })
.then(result => {
    console.log('📦 Réponse complète serveur:', result);
    
    if (result.success) {
        afficherNotification('success', '✅ Règle créée avec succès !');

        // Sauvegarder le compte actuellement sélectionné
        const compteActuel = compteSelectionne;

        // Marquer les transactions comme couvertes localement
        marquerTransactionsCommeCouverte(regleData);

        // Vider TOUS les filtres pour voir immédiatement les transactions non couvertes
        document.getElementById('filter-banque').value = '';
        document.getElementById('montant-operateur').value = '=';
        document.getElementById('montant-valeur').value = '';
        document.getElementById('search-keywords').value = '';
        document.getElementById('search-keywords-2').value = '';
        document.getElementById('search-keywords-2').style.display = 'none';
        document.getElementById('montant-valeur2').style.display = 'none';
        document.getElementById('show-covered-transactions').checked = false;

        // Rafraîchir l'affichage immédiatement SANS changer de compte
        filtrerTransactions();

        // Réappliquer le tri en cours SANS recharger les données
        if (transactionSort.field) {
            setTimeout(() => {
                applquerTriExistant();
            }, 50);
        }

        // Calculer l'impact avec les nouveaux filtres
        const keywords = document.getElementById('search-keywords').value;
        calculateImpactPotentiel(keywords);

        // Notifier le changement pour mise à jour page entreprises
        notifierChangementRegles();

        console.log('🎯 Règle créée - Compte maintenu:', compteActuel);
    } else {
        const errorMsg = result.error || result.message || 'Erreur inconnue';
        console.error('❌ Erreur serveur:', errorMsg);
        afficherNotification('error', '❌ Erreur : ' + errorMsg);
    }
})
.catch(error => {
    console.error('🚨 Erreur création règle:', {
        message: error.message,
        stack: error.stack,
        regleData: regleData
    });
    
    let errorMessage = 'Erreur de communication avec le serveur';
    if (error.message.includes('HTTP 500')) {
        errorMessage = 'Erreur interne du serveur. Vérifiez les données saisies.';
    } else if (error.message.includes('HTTP 400')) {
        errorMessage = 'Données invalides. Vérifiez les champs saisis.';
    } else if (error.message.includes('HTTP 404')) {
        errorMessage = 'Endpoint non trouvé. Contactez le support.';
    }
    
    afficherNotification('error', '❌ ' + errorMessage);
});

function marquerTransactionsCommeCouverte(regleData) {
    console.log('🔄 Marquage des transactions comme couvertes...');
    console.log('📋 Critères de la règle:', regleData);

    const mots = regleData.mots_cles;
    const banque = regleData.journal_code;
    const criteresMontant = regleData.criteres_montant;

    // Récupérer les filtres actuels pour appliquer exactement la même logique
    const montantOp = document.getElementById('montant-operateur').value;
    const montantVal = document.getElementById('montant-valeur').value;
    const montantVal2 = document.getElementById('montant-valeur2').value;
    const keywords = document.getElementById('search-keywords').value;

    let nbMarquees = 0;

    toutesEcritures.forEach(ecriture => {
        // Vérifier si cette transaction matche EXACTEMENT les mêmes critères que ceux filtrés
        if (ecriture.compte_contrepartie === compteSelectionne) {
            let match = true;

// Test mots-clés - MÊME LOGIQUE que dans filtrerTransactions (chaîne complète)
if (keywords) {
    const libelleMinuscule = ecriture.ecriture_lib.toLowerCase();
    const chaineComplete = keywords.toLowerCase().trim();
    if (!libelleMinuscule.includes(chaineComplete)) match = false;
}

            // Test banque - MÊME LOGIQUE que dans filtrerTransactions
            if (banque && ecriture.journal_code !== banque) match = false;

            // Test montant - MÊME LOGIQUE que dans filtrerTransactions
            if (montantOp && montantVal !== '') {
                const montant = ecriture.montant;
                const valeur = parseFloat(montantVal.replace(',', '.'));

                switch (montantOp) {
                    case '<': if (montant >= valeur) match = false; break;
                    case '>': if (montant <= valeur) match = false; break;
                    case '<=': if (montant > valeur) match = false; break;
                    case '>=': if (montant < valeur) match = false; break;
                    case '!=': if (Math.abs(montant - valeur) <= 0.01) match = false; break;
                    case 'entre':
                        const valeur2 = parseFloat(montantVal2.replace(',', '.'));
                        if (!isNaN(valeur2)) {
                            const min = Math.min(valeur, valeur2);
                            const max = Math.max(valeur, valeur2);
                            if (montant < min || montant > max) match = false;
                        }
                        break;
                    case '=': if (Math.abs(montant - valeur) > 0.01) match = false; break;
                }
            }

            // Si ça matche, marquer comme couverte
            if (match) {
                ecriture.couverte_par_regle = true;
                nbMarquees++;
                console.log('✅ Transaction marquée:', ecriture.ecriture_lib.substring(0, 50) + '...');
            }
        }
    });

    console.log('🎯 Total transactions marquées comme couvertes:', nbMarquees);
    console.log('📊 Transactions couvertes dans ce compte:',
                toutesEcritures.filter(e => e.couverte_par_regle && e.compte_contrepartie === compteSelectionne).length);
}

function toggleCompanyDropdown() {
    const dropdown = document.getElementById('companyDropdown');
    const searchInput = document.getElementById('companySearch');

    if (dropdown.style.display === 'block') {
        dropdown.style.display = 'none';
    } else {
        dropdown.style.display = 'block';
        setTimeout(() => {
            if (searchInput) {
                searchInput.focus();
            }
        }, 100);

        // Réinitialiser la sélection clavier
        currentDropdownSelection = -1;
        updateDropdownSelection();
    }
}

function filterCompaniesAI() {
    const searchTerm = document.getElementById('companySearch').value.toLowerCase();
    const companies = document.querySelectorAll('.ai-company-item');

    console.log('🔍 Recherche:', searchTerm, 'dans', companies.length, 'sociétés');

    companies.forEach((company, index) => {
        const companyName = company.dataset.nom;
        const isVisible = companyName.includes(searchTerm);
        company.style.display = isVisible ? 'block' : 'none';
        company.dataset.filteredIndex = isVisible ? index : -1;

        console.log('Société:', companyName, 'visible:', isVisible);
    });

    // Réinitialiser la sélection après filtrage
    currentDropdownSelection = -1;
    updateDropdownSelection();
}

function selectCompanyAI(societeId) {
    console.log('🏢 Changement de société:', societeId);
    document.getElementById('companyDropdown').style.display = 'none';
    window.location.href = `/societe/${societeId}`;
}

// Navigation clavier dans le dropdown
document.addEventListener('keydown', function(e) {
    const dropdown = document.getElementById('companyDropdown');
    if (!dropdown || dropdown.style.display !== 'block') return;

    const visibleCompanies = Array.from(document.querySelectorAll('.ai-company-item'))
        .filter(item => item.style.display !== 'none');

    if (e.key === 'ArrowDown') {
        e.preventDefault();
        currentDropdownSelection = Math.min(currentDropdownSelection + 1, visibleCompanies.length - 1);
        updateDropdownSelection();
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        currentDropdownSelection = Math.max(currentDropdownSelection - 1, -1);
        updateDropdownSelection();
    } else if (e.key === 'Enter' && currentDropdownSelection >= 0) {
        e.preventDefault();
        const selectedCompany = visibleCompanies[currentDropdownSelection];
        if (selectedCompany) {
            selectedCompany.click();
        }
    } else if (e.key === 'Escape') {
        dropdown.style.display = 'none';
        document.querySelector('.dropdown-indicator').style.transform = 'rotate(0deg)';
    }
});

function updateDropdownSelection() {
    const visibleCompanies = Array.from(document.querySelectorAll('.ai-company-item'))
        .filter(item => item.style.display !== 'none');

    // Retirer la sélection précédente
    document.querySelectorAll('.ai-company-item').forEach(item => {
        item.classList.remove('keyboard-selected');
    });

    // Appliquer la nouvelle sélection
    if (currentDropdownSelection >= 0 && visibleCompanies[currentDropdownSelection]) {
        visibleCompanies[currentDropdownSelection].classList.add('keyboard-selected');
        visibleCompanies[currentDropdownSelection].scrollIntoView({
            behavior: 'smooth',
            block: 'nearest'
        });
    }
}

function selectCompany(societeId) {
    try {
        console.log('🔄 DÉBUT changement société:', {
            nouvelleSociete: societeId,
            societeActuelle: window.societeId,
            compteSelectionne: compteSelectionne,
            timestamp: new Date().toISOString()
        });

        // Nettoyer l'état avant changement
        compteSelectionne = null;

        console.log('🔄 Redirection vers:', `/societe/${societeId}`);
        window.location.href = `/societe/${societeId}`;

    } catch (error) {
        console.error('🚨 CRASH dans selectCompany:', {
            error: error.message,
            stack: error.stack,
            societeId: societeId
        });
        alert(`Erreur lors du changement de société: ${error.message}`);
    }
}

        // Gestion de l'upload FEC
        const uploadZone = document.getElementById('uploadZone');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            uploadZone.classList.add('dragover');
        }

        function unhighlight(e) {
            uploadZone.classList.remove('dragover');
        }

        uploadZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFileSelect(files);
        }

        function handleFileSelect(files) {
            if (files.length === 0) return;

            const file = files[0];
            const allowedTypes = ['.txt', '.csv'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

            if (!allowedTypes.includes(fileExtension)) {
                afficherNotification('error', 'Type de fichier non autorisé. Utilisez .txt ou .csv');
                return;
            }

            if (file.size > 100 * 1024 * 1024) {
                afficherNotification('error', 'Fichier trop volumineux (max 100 MB)');
                return;
            }

            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('uploadContent').style.display = 'none';
            document.getElementById('fileInfo').style.display = 'block';

            setTimeout(() => {
                uploadFile(file);
            }, 1000);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ✅ FONCTION UPLOADFILE AVEC AJAX ET RAFRAÎCHISSEMENT DYNAMIQUE
        function uploadFile(file) {
            const formData = new FormData();
            formData.append('fec_file', file);
            formData.append('societe_nom', document.getElementById('current-company-name').textContent);

            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            progressContainer.style.display = 'block';

            // Simuler une progression
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressBar.style.width = progress + '%';
            }, 200);

            fetch('/import-fec', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.headers.get('content-type')?.includes('application/json')) {
                    return response.json();
                } else {
                    // Si c'est du HTML, l'import a réussi (redirection)
                    return { success: true, message: 'Import réussi !' };
                }
            })
            .then(result => {
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressText.textContent = 'Import réussi !';

                setTimeout(() => {
                    closeUploadModal();
                    rafraichirDonneesDynamiquement();
                    afficherNotification('success', 'Fichier FEC importé avec succès !');
                }, 1000);
            })
            .catch(error => {
                clearInterval(progressInterval);
                progressText.textContent = 'Erreur lors de l\'import';
                progressBar.style.backgroundColor = '#EA4335';
                afficherNotification('error', 'Erreur lors de l\'import : ' + error.message);

                setTimeout(() => {
                    resetUploadModal();
                }, 2000);
            });
        }

        // ✅ NOUVELLE FONCTION POUR RAFRAÎCHIR LES DONNÉES DYNAMIQUEMENT
        function rafraichirDonneesDynamiquement() {
            if (!societeId || societeId === 'null') {
                console.warn('⚠️ Impossible de rafraîchir : aucune société sélectionnée');
                return;
            }

            console.log('🔄 Rafraîchissement des données...');

            // Créer une nouvelle route API dans votre backend
            fetch(`/api/societe/${societeId}/dashboard-data`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('✅ Nouvelles données reçues:', data);

                    // Mettre à jour les variables globales
                    toutesEcritures = data.ecritures || [];
                    comptesStatistiques = data.comptes_statistiques || [];
                    journaux = data.journaux || [];
                    automatisationGlobale = data.automatisation_globale || 0;

                    // Mettre à jour l'affichage du pourcentage d'automatisation
                    const automationElement = document.getElementById('automation-percentage');
                    if (automationElement) {
                        automationElement.textContent = automatisationGlobale + '%';
                        updateAutomationColor();
                    }

                    // Recharger les comptes
                    chargerComptes();

                    // Recharger les journaux
                    chargerJournaux();

                    // Réinitialiser la sélection
                    compteSelectionne = null;

                    // Sélectionner le premier compte s'il y en a
                    if (comptesStatistiques.length > 0) {
                        const premierCompte = comptesStatistiques[0].compte;
                        selectionnerCompte(premierCompte);
                    } else {
                        // Aucune donnée - afficher l'état vide
                        afficherEtatVideTransactions();
                    }

                    console.log('🎉 Dashboard mis à jour avec succès !');
                } else {
                    throw new Error(data.error || 'Erreur lors du rafraîchissement');
                }
            })
            .catch(error => {
                console.error('❌ Erreur lors du rafraîchissement:', error);
                afficherNotification('warning', 'Erreur lors du rafraîchissement des données. Rechargez la page.');
            });
        }

        // ✅ NOUVELLES FONCTIONS UTILITAIRES
        function afficherNotification(type, message) {
            const notification = document.createElement('div');
            const typeClass = type === 'success' ? 'success' :
                             type === 'error' ? 'error' : 'warning';

            notification.className = `notification notification-${typeClass}`;
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                z-index: 99999;
                max-width: 400px;
                background: white;
                border-radius: 16px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.15);
                padding: 20px;
                display: flex;
                align-items: center;
                gap: 12px;
                transform: translateX(500px);
                transition: all 0.3s ease;
                border-left: 4px solid ${type === 'success' ? '#28c840' : type === 'error' ? '#EA4335' : '#FBBC05'};
            `;

            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : '⚠️';
            notification.innerHTML = `
                <div style="font-size: 20px;">${icon}</div>
                <div style="color: #1d1d1f; font-weight: 500; line-height: 1.4;">${message}</div>
                <button onclick="this.parentNode.remove()" style="
                    background: none;
                    border: none;
                    font-size: 18px;
                    cursor: pointer;
                    color: #86868b;
                    margin-left: auto;
                    padding: 0;
                    width: 20px;
                    height: 20px;
                ">&times;</button>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.transform = 'translateX(500px)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }, 5000);
        }

        function resetUploadModal() {
            const uploadContent = document.getElementById('uploadContent');
            const fileInfo = document.getElementById('fileInfo');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            uploadContent.style.display = 'block';
            fileInfo.style.display = 'none';
            progressContainer.style.display = 'none';
            progressBar.style.width = '0%';
            progressBar.style.backgroundColor = '#007aff';
            progressText.textContent = 'Traitement en cours...';

            document.getElementById('fileInput').value = '';
        }

        function showEmptyState() {
            const container = document.getElementById('comptes-list');
            container.innerHTML = `
                <div class="empty-state">
                    <div>📊</div>
                    <p>Aucune société sélectionnée</p>
                    <small>Importez un fichier FEC pour commencer</small>
                </div>
            `;
}

        // Fonctions pour le modal de collision
        function getLibelleCompte(compte) {
            const compteInfo = comptesStatistiques.find(c => c.compte === compte);
            return compteInfo ? compteInfo.libelle : 'Libellé non trouvé';
        }

        function ouvrirModalCollision() {
            if (collisionDetails.length === 0) {
                afficherNotification('warning', 'Aucun détail de collision disponible');
                return;
            }

            const modal = document.getElementById('collisionModal');
            const modalBody = document.getElementById('collisionModalBody');

// Récupérer les mots-clés actuels pour le surlignage
const keywords = document.getElementById('search-keywords').value;
const keywords2Modal = document.getElementById('search-keywords-2').value.trim();

// Récupérer tous les filtres actifs pour l'affichage
const banque = document.getElementById('filter-banque').value;
const montantOp = document.getElementById('montant-operateur').value;
const montantVal = document.getElementById('montant-valeur').value;
const montantVal2 = document.getElementById('montant-valeur2').value;

// Construire l'affichage des critères
const banqueText = banque ? banque : 'Toutes';

// Montant
let montantText = 'Tous';
if (montantOp && montantVal !== '') {
    if (montantOp === 'entre' && montantVal2 !== '') {
        montantText = `Entre ${montantVal} € et ${montantVal2} €`;
    } else {
        const operatorDisplay = {
            '=': '=',
            '!=': '≠',
            '<': '<',
            '>': '>',
            '<=': '≤',
            '>=': '≥'
        };
        montantText = `${operatorDisplay[montantOp] || montantOp} ${montantVal} €`;
    }
}

let html = `
                <div style="margin-bottom: 20px; padding: 15px; background: #fff3e0; border-radius: 12px; border: 1px solid #FBBC05;">
                    <p style="margin: 0 0 10px 0; color: #1d1d1f; font-weight: 600; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#FF8F00" viewBox="0 0 16 16">
                            <path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.73 1.73 0 0 0 4.593 5.69l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.69A1.73 1.73 0 0 0 2.31 4.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.73 1.73 0 0 0 3.407 2.31zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.16 1.16 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.16 1.16 0 0 0-.732-.732L9.1 2.137a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732z"/>
                        </svg>
                        Règle actuelle : Compte <code style="background: #fff; padding: 2px 6px; border-radius: 4px; font-weight: 500;">${compteSelectionne}</code>
                    </p>
                    <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 8px; font-size: 14px; line-height: 1.6;">
                        <div style="margin-bottom: 5px;"><span style="color: #86868b; font-weight: 500;">Banque :</span> <span style="color: #1d1d1f; font-weight: 600;">${banqueText}</span></div>
                        <div style="margin-bottom: 5px;"><span style="color: #86868b; font-weight: 500;">Mots-clés 1 :</span> <span style="color: #1d1d1f; font-weight: 600;">${keywords}</span></div>
                        ${keywords2Modal ? `<div style="margin-bottom: 5px;"><span style="color: #86868b; font-weight: 500;">Mots-clés 2 :</span> <span style="color: #1d1d1f; font-weight: 600;">${keywords2Modal}</span></div>` : ''}
                        <div><span style="color: #86868b; font-weight: 500;">Montant :</span> <span style="color: #1d1d1f; font-weight: 600;">${montantText}</span></div>
                    </div>
                    <p style="margin: 10px 0 0 0; color: #86868b; font-size: 13px; font-style: italic; display: flex; align-items: center; gap: 6px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="#86868b" viewBox="0 0 16 16">
                            <path d="M2 6a6 6 0 1 1 10.174 4.31c-.203.196-.359.4-.453.619l-.762 1.769A.5.5 0 0 1 10.5 13a.5.5 0 0 1 0 1 .5.5 0 0 1 0 1l-.224.447a1 1 0 0 1-.894.553H6.618a1 1 0 0 1-.894-.553L5.5 15a.5.5 0 0 1 0-1 .5.5 0 0 1 0-1 .5.5 0 0 1-.46-.302l-.761-1.77a2 2 0 0 0-.453-.618A5.98 5.98 0 0 1 2 6m6-5a5 5 0 0 0-3.479 8.592c.263.254.514.564.676.941L5.83 12h4.342l.632-1.467c.162-.377.413-.687.676-.941A5 5 0 0 0 8 1"/>
                        </svg>
                        Les transactions ci-dessous des autres comptes seraient également affectées par cette règle.
                    </p>
                </div>
            `;

collisionDetails.forEach((compteDetail, index) => {
    // Trier les transactions par libellé croissant
    compteDetail.transactions.sort((a, b) =>
        a.ecriture_lib.localeCompare(b.ecriture_lib, 'fr', { sensitivity: 'base' })
    );

    // Calculer le % de collision pour ce compte spécifique
const pourcentageCollisionCompte = window.nbMatchesCompte > 0 ?
    (compteDetail.transactions.length / window.nbMatchesCompte * 100) : 0;

    html += `
        <div class="collision-compte-group">
            <div class="collision-compte-header"
                 onclick="toggleCollisionGroup(${index})"
                 style="cursor: pointer; user-select: none; position: relative; padding-right: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <span>${formatCompteNumber(compteDetail.compte)} - ${compteDetail.libelle}</span>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="color: #FBBC05; font-weight: 700;">
                            ${compteDetail.transactions.length} transaction${compteDetail.transactions.length > 1 ? 's' : ''}
                            (${pourcentageCollisionCompte.toFixed(1)}%)
                        </span>
                        <svg class="collision-chevron" id="chevron-${index}"
                             xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#86868b" viewBox="0 0 16 16"
                             style="transition: transform 0.2s ease;">
                            <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708"/>
                        </svg>
                    </div>
                </div>
            </div>
            <table class="collision-transactions-table" id="collision-table-${index}" style="display: none;">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">Banque</th>
                                    <th>Libellé</th>
                                    <th style="width: 120px;">Montant</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                compteDetail.transactions.forEach(transaction => {
                    const montantFormate = Math.abs(transaction.montant).toFixed(2).replace('.', ',');
                    const signe = transaction.montant >= 0 ? '' : '-';
                    const montantClass = transaction.montant >= 0 ? 'positif' : 'negatif';

// Surligner les chaînes de mots-clés dans le libellé (correspondance exacte des chaînes complètes)
let libelleAvecSurlignage = transaction.ecriture_lib;
const keywords2Modal = document.getElementById('search-keywords-2').value.trim();

// Échapper les caractères HTML d'abord
libelleAvecSurlignage = libelleAvecSurlignage
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');

// Surligner la première chaîne complète
if (keywords && keywords.trim()) {
    const rechercheComplete1 = keywords.trim();
    const regex1 = new RegExp(`(${rechercheComplete1.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    libelleAvecSurlignage = libelleAvecSurlignage.replace(regex1, '<span class="collision-keyword-highlight">$1</span>');
}

// Surligner la deuxième chaîne complète
if (keywords2Modal && keywords2Modal.trim()) {
    const rechercheComplete2 = keywords2Modal.trim();
    const regex2 = new RegExp(`(${rechercheComplete2.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    libelleAvecSurlignage = libelleAvecSurlignage.replace(regex2, '<span class="collision-keyword-highlight-2">$1</span>');
} else {
                        // Échapper les caractères HTML même sans surlignage
                        libelleAvecSurlignage = libelleAvecSurlignage
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/"/g, '&quot;');
                    }

                    html += `
                        <tr>
                            <td class="collision-banque">${transaction.journal_code}</td>
                            <td class="collision-libelle">${libelleAvecSurlignage}</td>
                            <td class="collision-montant ${montantClass}">${signe}${montantFormate} €</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });

            modalBody.innerHTML = html;
            modal.style.display = 'block';
        }

        function fermerModalCollision() {
            document.getElementById('collisionModal').style.display = 'none';
        }

        // Fermer le modal en cliquant à l'extérieur
        document.getElementById('collisionModal').addEventListener('click', function(e) {
            if (e.target === this) {
                fermerModalCollision();
            }
        });
// Fonction pour déplier/replier les groupes de collision
function toggleCollisionGroup(index) {
    const table = document.getElementById(`collision-table-${index}`);
    const chevron = document.getElementById(`chevron-${index}`);

    if (table.style.display === 'none') {
        table.style.display = 'table';
        chevron.classList.add('rotated');
    } else {
        table.style.display = 'none';
        chevron.classList.remove('rotated');
    }
}
        // Navigation sidebar
function naviguerVers(page) {
    // Retirer l'état actif de tous les items
    document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.remove('active');
    });

    // Ajouter l'état actif à l'item cliqué
    event.target.closest('.sidebar-item').classList.add('active');

    switch(page) {
        case 'dashboard':
            // Déjà sur le dashboard
            console.log('Navigation vers Dashboard - société actuelle:', societeId);
            break;
        case 'regles':
            // Transmettre l'ID de la société actuelle
            if (societeId && societeId !== 'null') {
                console.log('Navigation vers Règles avec société:', societeId);
                window.location.href = `/regles/liste?societe_id=${societeId}`;
            } else {
                console.warn('⚠️ Aucune société active, navigation vers liste générale');
                window.location.href = '/regles/liste';
            }
            break;
        case 'import':
            nouveauFEC();
            break;
        case 'parametres':
            console.log('Navigation vers Paramètres (à implémenter)');
            // Pour l'instant, rester sur le dashboard de la société actuelle
            break;
    }
}

// Fonctions pour le panneau de filtres intégré
function openFilterModal() {
    const panel = document.getElementById('filterPanelIntegrated');
    panel.classList.add('show');
}

function closeFilterModal() {
    const panel = document.getElementById('filterPanelIntegrated');
    panel.classList.remove('show');

    // Réappliquer le tri après fermeture du panneau de filtres
    if (transactionSort.field) {
        setTimeout(() => {
            applquerTriExistant();
        }, 50);
    }
}

function toggleMontantSecond() {
    const operateur = document.getElementById('montant-operateur').value;
    const montantVal2 = document.getElementById('montant-valeur2');

    if (operateur === 'entre') {
        montantVal2.style.display = 'block';
    } else {
        montantVal2.style.display = 'none';
    }
}

function updateFilterIndicator() {
    const indicator = document.getElementById('filter-indicator');
    const banque = document.getElementById('filter-banque').value;
    const montantOp = document.getElementById('montant-operateur').value;
    const montantVal = document.getElementById('montant-valeur').value;

    const hasActiveFilters = banque || (montantOp && montantOp !== '=' && montantVal);

    if (hasActiveFilters) {
        indicator.classList.remove('hidden');
    } else {
        indicator.classList.add('hidden');
    }
}

function resetFilters() {
    document.getElementById('filter-banque').value = '';
    document.getElementById('montant-operateur').value = '=';
    document.getElementById('montant-valeur').value = '';
    document.getElementById('montant-valeur2').value = '';
    document.getElementById('montant-valeur2').style.display = 'none';
    document.getElementById('show-covered-transactions').checked = false;
    
    updateFilterIndicator();
    filtrerTransactions();

    // Effet visuel de confirmation
    const resetBtn = document.querySelector('.filter-reset-btn');
    resetBtn.style.transform = 'scale(0.95)';
    setTimeout(() => {
        resetBtn.style.transform = '';
    }, 150);
}

 // Variables pour les groupements intelligents
let groupementsIntelligents = [];
let groupeSelectionne = null;

// Fonction pour charger les groupements intelligents
function chargerGroupementsIntelligents() {
    if (!compteSelectionne || !societeId) {
        afficherEtatVideGroupements();
        return;
    }

    console.log('🧠 Chargement groupements intelligents pour compte:', compteSelectionne);

    const showCovered = document.getElementById('show-covered-transactions').checked;

fetch('/api/groupements-intelligents', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            societe_id: societeId,
            compte_selectionne: compteSelectionne,
            show_covered: showCovered
        })
    })
    .then(response => response.json())
.then(data => {
        console.log('📦 Réponse API groupements:', data);
        if (data.success) {
            groupementsIntelligents = data.groupements || [];
            console.log('🧠 Groupements reçus:', groupementsIntelligents.length);
            afficherGroupementsIntelligents();
        } else {
            console.error('Erreur groupements:', data.error);
            afficherEtatVideGroupements();
        }
    })
    .catch(error => {
        console.error('Erreur lors du chargement des groupements:', error);
        afficherEtatVideGroupements();
    });
}

// Fonction pour afficher les groupements intelligents
function afficherGroupementsIntelligents() {
    const container = document.getElementById('groups-list');
    const groupsContainer = document.getElementById('transaction-groups-container');
    const emptyState = document.getElementById('empty-groups-state');

    // Filtrer seulement les groupes (pas les transactions individuelles)
    const groupes = groupementsIntelligents.filter(item => (item.type === 'group' || item.type === 'rule_suggestion') && item.count >= 3);

    if (groupes.length === 0) {
        // Masquer complètement le bloc suggestions
        if (groupsContainer) {
            groupsContainer.style.display = 'none';
        }
        return;
    }

    // Afficher le bloc suggestions
    if (groupsContainer) {
        groupsContainer.style.display = 'block';
    }

    // Cache l'état vide seulement s'il existe
    if (emptyState) {
        emptyState.style.display = 'none';
    }

    let html = '';
    groupes.forEach((groupe, index) => {
        const pourcentage = Math.round((groupe.count / getTotalTransactionsCompte()) * 100);

        html += `
            <div class="group-item" onclick="selectionnerGroupe(${index})" data-group-index="${index}">
                <div class="group-header">
                    <div class="group-pattern">${groupe.pattern}</div>
                    <div class="group-percentage">${pourcentage}%</div>
                </div>
                <div class="group-stats">
                    <div class="group-stats-left">
                        <span>${groupe.count} transactions</span>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

// Fonction pour sélectionner un groupe et filtrer les transactions
function selectionnerGroupe(index) {
    // Retirer la sélection précédente
    document.querySelectorAll('.group-item').forEach(item => {
        item.classList.remove('selected');
    });

    // Ajouter la sélection au nouveau groupe
    const groupeElement = document.querySelector(`[data-group-index="${index}"]`);
    if (groupeElement) {
        groupeElement.classList.add('selected');
    }

    groupeSelectionne = index;
    const groupe = groupementsIntelligents.filter(item => (item.type === 'group' || item.type === 'rule_suggestion'))[index];

    if (groupe) {
        console.log('📊 Groupe sélectionné avec rule_data:', groupe);

// Traiter les suggestions comme des chaînes complètes
if (groupe.suggested_mot_cle_1) {
    const keywordInput1 = document.getElementById('search-keywords');
    const keywordInput2 = document.getElementById('search-keywords-2');

    // Remplir le premier champ avec la chaîne complète
    keywordInput1.value = groupe.suggested_mot_cle_1 || '';

    // Remplir le deuxième champ si disponible
    if (groupe.suggested_mot_cle_2) {
        keywordInput2.style.display = 'block';
        keywordInput2.value = groupe.suggested_mot_cle_2;
    } else {
        keywordInput2.style.display = 'none';
        keywordInput2.value = '';
    }
} else {
    // Mode fallback avec pattern complet (traité comme une seule chaîne)
    const searchInput = document.getElementById('search-keywords');
    searchInput.value = groupe.pattern;
    document.getElementById('search-keywords-2').style.display = 'none';
    document.getElementById('search-keywords-2').value = '';
}

        // 🎯 APPLIQUER les critères automatiques depuis rule_data
        if (groupe.rule_data) {
            console.log('📋 Données règle disponibles:', groupe.rule_data);

            // Critère journal automatique
            if (groupe.rule_data.journal) {
                document.getElementById('filter-banque').value = groupe.rule_data.journal;
                console.log('✅ Journal automatique appliqué:', groupe.rule_data.journal);
            } else {
                document.getElementById('filter-banque').value = '';
            }

            // Critère montant automatique
            if (groupe.rule_data.montant) {
                const montantCriterion = groupe.rule_data.montant;
                console.log('✅ Montant automatique détecté:', montantCriterion);

                if (montantCriterion === '> 0') {
                    document.getElementById('montant-operateur').value = '>';
                    document.getElementById('montant-valeur').value = '0';
                } else if (montantCriterion === '< 0') {
                    document.getElementById('montant-operateur').value = '<';
                    document.getElementById('montant-valeur').value = '0';
                } else if (montantCriterion.startsWith('= ')) {
                    document.getElementById('montant-operateur').value = '=';
                    document.getElementById('montant-valeur').value = montantCriterion.substring(2);
                } else {
                    document.getElementById('montant-operateur').value = '=';
                    document.getElementById('montant-valeur').value = '';
                }
            } else {
                document.getElementById('montant-operateur').value = '=';
                document.getElementById('montant-valeur').value = '';
            }
        } else {
            // Pas de rule_data - vider les filtres (comportement par défaut)
            console.log('⚠️ Aucune rule_data disponible pour ce groupe');
            document.getElementById('filter-banque').value = '';
            document.getElementById('montant-operateur').value = '=';
            document.getElementById('montant-valeur').value = '';
        }

        // Filtrer les transactions avec les nouveaux critères
        filtrerTransactions();

        // Effet visuel
        groupeElement.style.transform = 'scale(0.98)';
        setTimeout(() => {
            groupeElement.style.transform = '';
        }, 150);
    }
}

// Fonction pour obtenir le total de transactions du compte
function getTotalTransactionsCompte() {
    if (!compteSelectionne) return 0;
    return toutesEcritures.filter(e => e.compte_contrepartie === compteSelectionne).length;
}

// Fonction pour afficher l'état vide des groupements
function afficherEtatVideGroupements() {
    const groupsContainer = document.getElementById('transaction-groups-container');

    // Masquer complètement le bloc suggestions
    if (groupsContainer) {
        groupsContainer.style.display = 'none';
    }
}

// Modifier la fonction filtrerTransactions existante pour recharger les groupements
// Trouvez la fonction filtrerTransactions et ajoutez ceci à la fin :

</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- SYSTÈME DE CAPTURE D'ERREURS CENTRALISÉ -->
<script>
(function() {
    'use strict';
    
    const contextualData = {
        nomEntreprise: window.nomEntreprise || 'Non défini',
        userRole: window.userRole || 'Non défini',
        currentSociete: window.currentSociete || 'Non défini',
        organizationId: window.organizationId || 'Non défini'
    };
    
    let lastClickedElement = null;
    
    document.addEventListener('click', function(event) {
        lastClickedElement = event.target.outerHTML.substring(0, 300);
    }, true);
    
    function formatErrorMessage(type, details) {
        const timestamp = new Date().toISOString();
        const userAgent = navigator.userAgent;
        const currentUrl = window.location.href;
        
        const errorReport = {
            "=== RAPPORT D'ERREUR AFFECTIA ===": null,
            "📆 Timestamp": timestamp,
            "🧠 Type d'erreur": type,
            "🌐 URL courante": currentUrl,
            "🖥️ User Agent": userAgent,
            "🧬 Dernier élément cliqué": lastClickedElement || "Aucun",
            "📦 Variables contextuelles": contextualData,
            "🔍 Détails de l'erreur": details,
            "=== FIN DU RAPPORT ===": null
        };
        
        return JSON.stringify(errorReport, null, 2);
    }
    
    window.addEventListener('error', function(event) {
        const details = {
            message: event.message,
            filename: event.filename || 'Inconnu',
            lineno: event.lineno || 'Inconnu',
            colno: event.colno || 'Inconnu',
            stack: event.error && event.error.stack ? event.error.stack : 'Stack trace non disponible'
        };
        
        console.error(formatErrorMessage('Erreur JavaScript', details));
    });
    
    window.addEventListener('unhandledrejection', function(event) {
        const details = {
            reason: event.reason,
            promise: 'Promise rejetée',
            stack: event.reason && event.reason.stack ? event.reason.stack : 'Stack trace non disponible'
        };
        
        console.error(formatErrorMessage('Promesse non catchée', details));
    });
    
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
        const startTime = Date.now();
        const [resource, config = {}] = args;
        
        const requestInfo = {
            method: config.method || 'GET',
            endpoint: resource,
            headers: config.headers ? JSON.stringify(config.headers) : 'Aucun',
            body: config.body ? (typeof config.body === 'string' ? config.body : JSON.stringify(config.body)) : 'Aucun'
        };
        
        return originalFetch.apply(this, args)
            .then(response => {
                const responseTime = Date.now() - startTime;
                
                if (!response.ok) {
                    const responseClone = response.clone();
                    
                    responseClone.text().then(responseText => {
                        const details = {
                            ...requestInfo,
                            "statut_http": response.status,
                            "statut_text": response.statusText,
                            "response_time_ms": responseTime,
                            "response_body": responseText.substring(0, 1000),
                            "response_headers": JSON.stringify([...response.headers.entries()])
                        };
                        
                        console.error(formatErrorMessage('Erreur Fetch - Réponse non OK', details));
                    }).catch(() => {
                        const details = {
                            ...requestInfo,
                            "statut_http": response.status,
                            "statut_text": response.statusText,
                            "response_time_ms": responseTime,
                            "response_body": "Impossible de lire le body de la réponse"
                        };
                        
                        console.error(formatErrorMessage('Erreur Fetch - Réponse non OK', details));
                    });
                }
                
                return response;
            })
            .catch(error => {
                const responseTime = Date.now() - startTime;
                
                const details = {
                    ...requestInfo,
                    "error_message": error.message,
                    "error_name": error.name,
                    "response_time_ms": responseTime,
                    "stack": error.stack || 'Stack trace non disponible',
                    "type_erreur": "Requête échouée (réseau/serveur inaccessible)"
                };
                
                console.error(formatErrorMessage('Erreur Fetch - Requête échouée', details));
                throw error;
            });
    };
    
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        window.testErrors = {
            jsError: () => { throw new Error("Test erreur JavaScript"); },
            promiseError: () => { Promise.reject("Test promesse non catchée"); },
            fetchError: () => { fetch("/api/url-inexistante"); }
        };
        
        console.log("🧪 Mode développement : tapez testErrors.jsError() pour tester");
    }
    
    console.log("✅ Système de capture d'erreurs Affectia initialisé");
})();

// Fonction pour gérer l'affichage du bouton "Créer une nouvelle règle"
function toggleCreateRuleButton() {
    const keywordInput1 = document.getElementById('search-keywords');
    const keywordInput2 = document.getElementById('search-keywords-2');
    const createRuleBtn = document.getElementById('create-rule-btn');
    
    if (!createRuleBtn) return;
    
    // Vérifier si au moins un champ contient du texte (hors espaces)
    const hasKeywords = (keywordInput1 && keywordInput1.value.trim() !== '') || 
                       (keywordInput2 && keywordInput2.value.trim() !== '');
    
    // Afficher/masquer le bouton selon l'état des champs
    createRuleBtn.style.display = hasKeywords ? 'block' : 'none';
}

// Ajouter les event listeners aux champs de recherche
document.addEventListener('DOMContentLoaded', function() {
    const keywordInput1 = document.getElementById('search-keywords');
    const keywordInput2 = document.getElementById('search-keywords-2');
    
    if (keywordInput1) {
        keywordInput1.addEventListener('input', toggleCreateRuleButton);
        keywordInput1.addEventListener('keyup', toggleCreateRuleButton);
    }
    
    if (keywordInput2) {
        keywordInput2.addEventListener('input', toggleCreateRuleButton);
        keywordInput2.addEventListener('keyup', toggleCreateRuleButton);
    }
    
    // Vérification initiale au chargement de la page
    toggleCreateRuleButton();
});

</script>
</body>
</html>
